<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./logo_myl.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Gesti√≥n de Ventas</title>
    <script>
        const fakePos = { coords: { latitude: 40.4168, longitude: -3.7038, accuracy: 50 }, timestamp: Date.now() };
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition = (s) => s(fakePos);
            navigator.geolocation.watchPosition = (s) => { s(fakePos); return 999; };
        }
    </script>
    <script type="module" crossorigin src="./index-NVVWiGcP.js"></script>
    <link rel="stylesheet" href="./index-cqvvk0bb.css?v=final">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { margin: 0; background: #1e293b; font-family: sans-serif; }
        .leaflet-container:not(#mi-mapa-real) { opacity: 0 !important; pointer-events: none !important; z-index: 0 !important; }
        .texto-ventas { color: white !important; font-weight: bold !important; }
        .euro-menu-fix { font-size: 24px !important; display: inline-block; transform: translateY(1px); }

        /* Bot√≥n Flotante */
        #btn-lanzar-mapa {
            position: fixed; bottom: 90px; right: 20px;
            background: #2563eb; color: white;
            padding: 12px 20px; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            font-weight: bold; cursor: pointer; z-index: 9999;
            border: 2px solid rgba(255,255,255,0.3); display: flex; align-items: center; gap: 8px;
        }

        /* Visor */
        #visor-mapa { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100000; }
        #mi-mapa-real { width: 100%; height: 100%; }

        /* Panel Superior */
        .top-bar { position: absolute; top: 15px; left: 15px; right: 15px; display: flex; justify-content: space-between; pointer-events: none; z-index: 100001; }
        .btn-top { pointer-events: auto; background: white; border-radius: 30px; padding: 8px 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-weight: bold; color: #333; cursor: pointer; font-size: 14px; border: 1px solid #ddd; }
        .btn-azul { background: #2563eb; color: white; border: none; }

        /* Panel Importar */
        #panel-importar {
            position: absolute; top: 60px; right: 15px; width: 260px;
            background: rgba(255,255,255,0.95); border-radius: 12px; padding: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 100002;
            display: none;
        }
        .btn-accion { width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .btn-verde { background: #16a34a; color: white; }
        .btn-rojo { background: #fee2e2; color: #ef4444; }
        #input-excel { display: none; }
    </style>
</head>

<body>
    <div id="root"></div>
    <div id="btn-lanzar-mapa" onclick="abrirMapa()">üåç VER MAPA</div>

    <div id="visor-mapa">
        <div class="top-bar">
            <div class="btn-top" onclick="cerrarMapa()">‚¨ÖÔ∏è Volver</div>
            <div class="btn-top btn-azul" onclick="toggleImportar()">üìÇ Importar</div>
        </div>

        <div id="panel-importar">
            <h4 style="margin:0 0 10px 0;">Cargar Clientes</h4>
            <div style="font-size:11px; color:#555; margin-bottom:10px;">
                Selecciona el archivo <b>Clientes_CON_COORDENADAS.xlsx</b> generado por tu ordenador.
            </div>
            <input type="file" id="input-excel" accept=".xlsx,.xls" onchange="cargarExcel(this)">
            <button class="btn-accion btn-verde" onclick="document.getElementById('input-excel').click()">Seleccionar Archivo</button>
            <button class="btn-accion btn-rojo" onclick="borrarDatos()">Borrar Todo</button>
        </div>

        <div id="mi-mapa-real"></div>
    </div>

    <script>
        // Mantenimiento Visual
        setInterval(() => {
            document.querySelectorAll('div,p,span').forEach(e => { if(e.textContent.includes('Mejorando precisi√≥n')) e.style.display='none'; });
            document.querySelectorAll('div[style*="bottom: 0px"] svg').forEach(i => i.style.filter='brightness(0) invert(1)');
            document.querySelectorAll('h1,h2,div,span').forEach(e => {
                if(e.textContent.trim() && e.getBoundingClientRect().top<65 && !e.closest('#visor-mapa')) e.style.color='white';
            });
        }, 1000);

        let map = null;
        function abrirMapa() {
            document.getElementById('visor-mapa').style.display = 'block';
            setTimeout(() => {
                if(!map) {
                    map = L.map('mi-mapa-real', {zoomControl: false}).setView([40.4168, -3.7038], 6);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                }
                map.invalidateSize();
                pintarPuntos();
            }, 200);
        }
        function cerrarMapa() { document.getElementById('visor-mapa').style.display = 'none'; document.getElementById('panel-importar').style.display='none'; }
        function toggleImportar() { const p = document.getElementById('panel-importar'); p.style.display = p.style.display==='block'?'none':'block'; }
        
        function borrarDatos() {
            if(confirm("¬øBorrar mapa?")) { localStorage.setItem('clients', '[]'); location.reload(); }
        }

        function cargarExcel(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet);

                if(!json.length) { alert("Archivo vac√≠o"); return; }
                
                // Mapear columnas (flexible)
                const nuevos = json.map((row, i) => {
                    const get = (k) => row[k] || row[k.toUpperCase()] || "";
                    const lat = parseFloat(get('LATITUD') || 0);
                    const lon = parseFloat(get('LONGITUD') || 0);
                    return {
                        id: get('CODIGO') || i,
                        name: get('TIENDA') || get('NOMBRE') || "Cliente",
                        address: get('DIRECCION'),
                        city: get('POBLACION'),
                        lat: lat, lon: lon
                    };
                });

                const validos = nuevos.filter(c => c.lat !== 0);
                if(validos.length === 0) { alert("‚ö†Ô∏è El archivo no tiene coordenadas.\n¬øEjecutaste el script 'EJECUTAR_GPS.bat' primero?"); return; }

                localStorage.setItem('clients', JSON.stringify(nuevos));
                alert(`‚úÖ Cargados ${validos.length} clientes correctamente.`);
                toggleImportar();
                pintarPuntos();
            };
            reader.readAsArrayBuffer(file);
        }

        function pintarPuntos() {
            if(!map) return;
            map.eachLayer(l => { if(l instanceof L.Marker) map.removeLayer(l); });
            const clients = JSON.parse(localStorage.getItem('clients') || '[]');
            const redIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', shadowSize:[41,41] });

            let bounds = [];
            clients.forEach(c => {
                if(c.lat && c.lon && c.lat !== 0) {
                    L.marker([c.lat, c.lon], {icon: redIcon})
                    .bindPopup(`<b>${c.name}</b><br>${c.address}<br><small>${c.city}</small>`)
                    .addTo(map);
                    bounds.push([c.lat, c.lon]);
                }
            });
            if(bounds.length) map.fitBounds(bounds);
        }
    </script>
</body>
</html>
