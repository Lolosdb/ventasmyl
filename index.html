<!doctype html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./logo_myl.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-title" content="Ventas M&L" />
    <title>Gesti√≥n de Ventas</title>

    <script type="module" crossorigin src="./index-NVVWiGcP.js"></script>
    <link rel="stylesheet" href="./index-cqvvk0bb.css?v=final">
    <link rel="manifest" href="./manifest.webmanifest">

    <style>
        /* --- ESTILOS QUIR√öRGICOS --- */

        /* 1. Contador de pedidos (Limpio y profesional) */
        .contador-pedidos-extra {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
            color: #64748b;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        /* 2. Arreglo S√≠mbolo Euro en Men√∫ */
        .euro-menu-fix {
            font-size: 24px !important;
            display: inline-block;
            line-height: 1;
            transform: translateY(1px);
        }

        /* 3. Textos Ventas (Anteriormente Anual) */
        .texto-ventas {
            text-transform: uppercase !important;
            font-weight: 700 !important;
            color: #3b82f6 !important;
        }

        /* 4. Fechas (Ficha Cliente) */
        .fecha-espanol {
            font-size: 11px !important;
            font-weight: 700 !important;
            color: #94a3b8 !important;
            margin-bottom: 2px !important;
            display: block !important;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script>
        // ==========================================
        // 1. C√ÅLCULO DE PEDIDOS (L√≥gica Reforzada)
        // ==========================================
        function contarPedidos() {
            const resultado = { 'ASTURIAS': 0, 'CANTABRIA': 0, 'LEON': 0, 'GALICIA': 0 };
            try {
                const raw = localStorage.getItem('ventas-storage');
                if (!raw) return resultado;

                const db = JSON.parse(raw);
                if (!db.orders) return resultado;

                const anio = localStorage.getItem('selectedYear') || new Date().getFullYear().toString();

                // --- MAPEO DE CLIENTES (Nombre y C√≥digo) ---
                const mapaClientes = {};
                if (db.clients) {
                    db.clients.forEach(c => {
                        // Datos del cliente
                        const prov = c.province || c.provincia || c.Provincia || c.region;

                        if (prov) {
                            const provinciaNorm = prov.trim().toUpperCase();

                            // Mapeamos por NOMBRE
                            if (c.name) mapaClientes[c.name.trim().toUpperCase()] = provinciaNorm;
                            if (c.nombre) mapaClientes[c.nombre.trim().toUpperCase()] = provinciaNorm;
                            if (c.razonSocial) mapaClientes[c.razonSocial.trim().toUpperCase()] = provinciaNorm;

                            // Mapeamos por C√ìDIGO (Clave para que funcione si usan IDs)
                            if (c.code) mapaClientes[String(c.code).trim()] = provinciaNorm;
                            if (c.id) mapaClientes[String(c.id).trim()] = provinciaNorm;
                            if (c.codigo) mapaClientes[String(c.codigo).trim()] = provinciaNorm;
                        }
                    });
                }

                // --- CONTEO ---
                db.orders.forEach(o => {
                    // Verificamos fecha (flexible por si acaso)
                    if (o.date && String(o.date).startsWith(anio)) {

                        // Intentamos encontrar la provincia usando Nombre O C√≥digo
                        let prov = null;

                        // Intento 1: Por nombre
                        if (o.clientName) prov = mapaClientes[o.clientName.trim().toUpperCase()];

                        // Intento 2: Por c√≥digo/ID (si falla el nombre)
                        if (!prov && o.clientId) prov = mapaClientes[String(o.clientId).trim()];
                        if (!prov && o.clientCode) prov = mapaClientes[String(o.clientCode).trim()];

                        if (prov) {
                            if (prov.includes('ASTURIAS')) resultado['ASTURIAS']++;
                            else if (prov.includes('CANTABRIA')) resultado['CANTABRIA']++;
                            else if (prov.includes('LEON') || prov.includes('LE√ìN')) resultado['LEON']++;
                            else if (['LUGO', 'ORENSE', 'PONTEVEDRA', 'CORU√ëA', 'A CORU√ëA', 'A CORUNA'].some(x => prov.includes(x))) resultado['GALICIA']++;
                        }
                    }
                });
            } catch (e) { console.error("Error contadores:", e); }
            return resultado;
        }

        // ==========================================
        // 2. EL ARREGLADOR VISUAL (Intervalo)
        // ==========================================
        setInterval(() => {

            // --- A. MEN√ö INFERIOR (ESTRATEGIA SEGURA) ---
            // 1. Buscamos el texto "Dash"
            const dashSpans = Array.from(document.querySelectorAll('span, p, div')).filter(e => e.textContent.trim() === 'Dash');
            let barraMenu = null;

            // 2. Identificamos cu√°l es el del men√∫ de abajo (por posici√≥n)
            for (const span of dashSpans) {
                const rect = span.getBoundingClientRect();
                // Si est√° en los √∫ltimos 100px de la pantalla, ES EL MEN√ö
                if (rect.top > window.innerHeight - 100) {
                    // Buscamos el contenedor padre (la barra entera)
                    // Subimos 2 o 3 niveles hasta encontrar el contenedor flex
                    let candidato = span.parentElement;
                    for (let k = 0; k < 3; k++) {
                        if (candidato && candidate.parentElement) {
                            // Si el padre tiene varios hijos (botones), es la barra
                            if (candidato.parentElement.children.length > 4) {
                                barraMenu = candidate.parentElement;
                                break;
                            }
                        }
                        candidato = candidate.parentElement;
                    }
                }
                if (barraMenu) break;
            }

            // 3. Si encontramos la barra, aplicamos estilos SOLO A SUS HIJOS
            if (barraMenu) {
                Array.from(barraMenu.children).forEach(boton => {
                    // Limpieza base
                    boton.style.backgroundColor = 'transparent';
                    boton.style.boxShadow = 'none';
                    boton.style.border = 'none';

                    // Color blanco a textos e iconos
                    const hijos = boton.querySelectorAll('*');
                    hijos.forEach(hijo => {
                        // Texto blanco
                        if (hijo.tagName !== 'SVG' && hijo.tagName !== 'IMG') {
                            hijo.style.color = '#ffffff';
                        }
                        // Arreglo especial Euro
                        if (hijo.textContent.includes('‚Ç¨') && !hijo.classList.contains('euro-menu-fix')) {
                            hijo.classList.add('euro-menu-fix');
                        }
                    });

                    // Iconos SVG -> Blanco
                    const iconos = boton.querySelectorAll('svg, img');
                    iconos.forEach(ico => ico.style.filter = 'brightness(0) invert(1)');

                    // Borde activo (si tiene fondo azul o clase active)
                    const estilo = window.getComputedStyle(boton);
                    if (boton.className.includes('active') || estilo.backgroundColor.includes('235') || location.href.includes(boton.textContent.trim().toLowerCase())) {
                        boton.style.borderBottom = '3px solid white';
                        boton.style.paddingBottom = '4px';
                    } else {
                        boton.style.borderBottom = 'none';
                    }
                });
            }

            // --- B. CONTADORES DE PEDIDOS ---
            const contadores = contarPedidos();
            const zonas = ['ASTURIAS', 'CANTABRIA', 'LEON', 'LE√ìN', 'GALICIA'];

            document.querySelectorAll('h3, span, div, p').forEach(el => {
                const texto = el.textContent.trim().toUpperCase();
                if (zonas.includes(texto)) {
                    // Buscar tarjeta padre
                    let tarjeta = el.parentElement;
                    let encontrada = false;
                    for (let i = 0; i < 5; i++) {
                        if (!tarjeta) break;
                        const s = window.getComputedStyle(tarjeta);
                        // Detectar tarjeta blanca
                        if (s.backgroundColor.includes('255, 255, 255') || s.boxShadow !== 'none') {
                            encontrada = true;
                            break;
                        }
                        tarjeta = tarjeta.parentElement;
                    }

                    if (encontrada && tarjeta) {
                        const key = (texto === 'LE√ìN') ? 'LEON' : texto;
                        const num = contadores[key];

                        // 1. Ordenar Precio (debajo del t√≠tulo)
                        const precio = Array.from(tarjeta.querySelectorAll('*')).find(x => x.textContent.includes('‚Ç¨') && x !== tarjeta);
                        if (precio && el.nextElementSibling !== precio) {
                            el.after(precio);
                            precio.style.display = 'block';
                            precio.style.marginBottom = '4px';
                        }

                        // 2. Inyectar Contador (Debajo del precio si existe)
                        let contadorEl = tarjeta.querySelector('.contador-pedidos-extra');
                        if (!contadorEl) {
                            contadorEl = document.createElement('div');
                            contadorEl.className = 'contador-pedidos-extra';
                            if (precio) precio.after(contadorEl);
                            else tarjeta.appendChild(contadorEl);
                        }

                        const textoFinal = `üì¶ ${num} Pedidos`;
                        if (contadorEl.textContent !== textoFinal) {
                            contadorEl.textContent = textoFinal;
                        }
                    }
                }
            });

            // --- C. TEXTOS GENERALES ---
            document.querySelectorAll('*').forEach(el => {
                if (el.children.length === 0 && el.textContent.trim()) {
                    const t = el.textContent.trim().toUpperCase();
                    if (t === "HIST√ìRICO" || t === "HISTORICO" || t === "ANUAL" || el.textContent.trim().toUpperCase() === "HIST√ìRICO" || el.textContent.trim().toUpperCase() === "ANUAL") {
                        el.textContent = "VENTAS";
                        el.classList.add('texto-ventas');
                    }
                    if (t === "MEDIA MENSUAL GLOBAL") {
                        el.textContent = "MEDIA ANUAL";
                    }
                    if (t === "HIST√ìRICO VENTAS" || el.textContent.trim().toUpperCase() === "HIST√ìRICO VENTAS") {
                        el.textContent = "Medias mensuales";
                    }
                }
            });

            // --- D. TOP CLIENTES (CIFRAS M√ÅS GRANDES) ---
            document.querySelectorAll('*').forEach(el => {
                if (el.children.length === 0 && el.textContent.includes(' ‚Ç¨') && !el.classList.contains('euro-menu-fix')) {
                    // Si el tama√±o es peque√±o (ej. 0.75rem o 12px), lo subimos un poco
                    const s = window.getComputedStyle(el);
                    const size = parseFloat(s.fontSize);
                    if (size < 13) {
                        el.style.fontSize = '13px';
                        el.style.fontWeight = '600';
                        el.style.opacity = '0.9';
                    }
                }
            });

            // --- E. FECHAS (FORMATO Y TAMA√ëO) ---
            document.querySelectorAll('*').forEach(el => {
                if (el.children.length === 0) {
                    const t = el.textContent.trim();
                    if (/^\d{4}-\d{2}-\d{2}$/.test(t)) {
                        const [y, m, d] = t.split('-');
                        el.textContent = `${d}-${m}-${y}`;
                        el.classList.add('fecha-espanol');
                    }
                }
            });

        }, 500);
    </script>
</body>

</html>