<!doctype html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./logo_myl.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Gesti√≥n de Ventas</title>

    <script>
        // Enga√±amos a la app diciendo que el GPS no funciona o devolviendo una posici√≥n fija falsa
        // Esto elimina el mensaje "Mejorando precisi√≥n" inmediatamente.
        try {
            navigator.geolocation.watchPosition = function(success, error, options) {
                console.log("üö´ GPS Bloqueado por usuario");
                return 0; // No hacer nada
            };
            navigator.geolocation.getCurrentPosition = function(success, error, options) {
                console.log("üö´ GPS Bloqueado por usuario");
                // Opcional: Devolver una posici√≥n falsa para que la app no se queje
                if(success) success({ coords: { latitude: 40.4168, longitude: -3.7038, accuracy: 1000 } });
            };
        } catch(e) {}
    </script>

    <script type="module" crossorigin src="./index-NVVWiGcP.js"></script>
    <link rel="stylesheet" href="./index-cqvvk0bb.css?v=final">
    <link rel="manifest" href="./manifest.webmanifest">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <style>
        /* Ocultar mensaje de precisi√≥n si aparece en HTML */
        div:contains("Mejorando precisi√≥n"), p:contains("Mejorando precisi√≥n"), span:contains("Mejorando precisi√≥n") {
            display: none !important;
        }

        /* Ocultar el mapa original de la app para que no moleste */
        .leaflet-container:not(#mapa-real) {
            display: none !important;
            opacity: 0 !important;
            pointer-events: none !important;
            height: 0 !important;
        }

        /* Bot√≥n Flotante para abrir NUESTRO mapa */
        #btn-abrir-mapa {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background-color: #2563eb;
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 9999;
            font-weight: bold;
            font-family: sans-serif;
            border: 2px solid white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Contenedor de NUESTRO Mapa */
        #capa-mapa-seguro {
            display: none;
            position: fixed;
            top: 0; 
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 2147483647; /* M√°ximo Z-Index posible */
        }

        #mapa-real { width: 100%; height: 100%; }

        .map-controls {
            position: absolute; top: 10px; right: 10px; z-index: 10000;
            background: rgba(255, 255, 255, 0.95); padding: 10px;
            border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            width: 200px; text-align: center; font-family: sans-serif;
        }

        .btn-close {
            position: absolute; top: -10px; left: -10px;
            width: 36px; height: 36px; background: white;
            border: 2px solid #ccc; border-radius: 50%;
            font-weight: bold; font-size: 18px; line-height: 32px;
            cursor: pointer; color: #333;
        }

        /* Estilos visuales app */
        .euro-menu-fix { font-size: 24px !important; display: inline-block; line-height: 1; transform: translateY(1px); }
        .texto-ventas { text-transform: uppercase !important; font-weight: 700 !important; color: #ffffff !important; }
        .fecha-espanol { font-size: 11px !important; font-weight: 700 !important; color: #94a3b8 !important; margin-bottom: 2px !important; display: block !important; }
    </style>
</head>

<body>
    <div id="root"></div>

    <div id="btn-abrir-mapa" onclick="abrirMapaSeguro()">
        üó∫Ô∏è VER MAPA
    </div>

    <div id="capa-mapa-seguro">
        <div class="map-controls">
            <button class="btn-close" onclick="cerrarMapa()">‚úï</button>
            <div id="status-text" style="font-size:12px; font-weight:bold; margin-bottom:8px; color:#444;">
                Cargando mapa...
            </div>
            <button onclick="resetearDatos()" style="background:#ef4444; color:white; border:none; padding:8px; width:100%; border-radius:4px; font-weight:bold; cursor:pointer;">
                üóëÔ∏è Resetear Fallos
            </button>
        </div>
        <div id="mapa-real"></div>
    </div>

    <script>
        // --- FUNCIONES GLOBALES ---
        window.abrirMapaSeguro = function() {
            document.getElementById('capa-mapa-seguro').style.display = 'block';
            setTimeout(iniciarMapa, 100);
        };

        window.cerrarMapa = function() {
            document.getElementById('capa-mapa-seguro').style.display = 'none';
        };

        window.resetearDatos = function() {
            if(confirm("¬øBorrar ubicaciones guardadas y re-calcular?")) {
                try {
                    const clients = JSON.parse(localStorage.getItem('clients') || '[]');
                    clients.forEach(c => { c.lat = 0; c.lon = 0; });
                    localStorage.setItem('clients', JSON.stringify(clients));
                    alert("Datos limpios. Se buscar√°n las direcciones de nuevo.");
                    location.reload();
                } catch(e) { alert("Error: " + e); }
            }
        };

        // --- L√ìGICA DEL MAPA ---
        let mapInstance = null;

        function iniciarMapa() {
            if (mapInstance) {
                mapInstance.invalidateSize(); // Corregir gris
                return; 
            }

            try {
                mapInstance = L.map('mapa-real').setView([40.4168, -3.7038], 6);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap'
                }).addTo(mapInstance);

                cargarPuntos();
            } catch (e) {
                console.error(e);
                document.getElementById('status-text').innerText = "Error: " + e.message;
            }
        }

        function cargarPuntos() {
            if (!mapInstance) return;
            
            // Limpiar
            mapInstance.eachLayer(layer => { if (layer instanceof L.Marker) mapInstance.removeLayer(layer); });

            try {
                const clients = JSON.parse(localStorage.getItem('clients') || '[]');
                const orders = JSON.parse(localStorage.getItem('orders') || '[]');
                const now = new Date();
                const thirtyDaysAgo = new Date(); 
                thirtyDaysAgo.setDate(now.getDate() - 30);

                // Iconos
                const LeafIcon = L.Icon.extend({
                    options: { iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', shadowSize: [41, 41] }
                });
                const greenIcon = new LeafIcon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png' });
                const redIcon = new LeafIcon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png' });

                let pendientes = 0;
                let ubicados = 0;

                clients.forEach(c => {
                    if (c.lat && c.lon && c.lat !== 0) {
                        ubicados++;
                        let lastOrderDate = null;
                        const misPedidos = orders.filter(o => o.cliente_id == c.id || (o.cliente && o.cliente.includes(c.name)));
                        if (misPedidos.length > 0) {
                            misPedidos.sort((a,b) => new Date(b.fecha||b.timestamp) - new Date(a.fecha||a.timestamp));
                            lastOrderDate = new Date(misPedidos[0].fecha||misPedidos[0].timestamp);
                        }
                        const icon = (lastOrderDate && lastOrderDate >= thirtyDaysAgo) ? greenIcon : redIcon;
                        
                        L.marker([c.lat, c.lon], { icon: icon })
                            .bindPopup(`<b>${c.name}</b><br>${c.address || ''}`)
                            .addTo(mapInstance);
                    } else {
                        pendientes++;
                    }
                });

                document.getElementById('status-text').innerHTML = `Clientes: ${ubicados}<br>Faltan: ${pendientes}`;
                
                if (pendientes > 0) setTimeout(autoGeocodeOne, 1000); // Iniciar buscador

            } catch (e) { console.error(e); }
        }

        // --- GEOCODIFICADOR LENTO (Background) ---
        async function autoGeocodeOne() {
            // Solo buscar si el mapa est√° abierto para no gastar bater√≠a
            if (document.getElementById('capa-mapa-seguro').style.display === 'none') {
                setTimeout(autoGeocodeOne, 3000); 
                return;
            }

            try {
                const clients = JSON.parse(localStorage.getItem('clients') || '[]');
                const target = clients.find(c => (c.address && c.address.length > 4) && (!c.lat || c.lat === 0));

                if (target) {
                    const query = `${target.address}, ${target.city||''}, ${target.province||''}, Espa√±a`;
                    document.getElementById('status-text').innerHTML = `Buscando:<br>${target.name.substring(0,10)}...`;
                    
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`);
                    if (res.ok) {
                        const data = await res.json();
                        if (data.length > 0) {
                            target.lat = parseFloat(data[0].lat);
                            target.lon = parseFloat(data[0].lon);
                            
                            // Guardar en array original
                            const idx = clients.findIndex(x => x.id === target.id);
                            if(idx !== -1) clients[idx] = target;
                            
                            localStorage.setItem('clients', JSON.stringify(clients));
                            cargarPuntos(); // Refrescar mapa
                        } else {
                            // No encontrado: Marcar para saltar (lat=0.0001)
                            target.lat = 0.0001; 
                            const idx = clients.findIndex(x => x.id === target.id);
                            if(idx !== -1) clients[idx] = target;
                            localStorage.setItem('clients', JSON.stringify(clients));
                        }
                    }
                } else {
                    document.getElementById('status-text').innerText = "Todo ubicado.";
                }
            } catch(e) {}
            setTimeout(autoGeocodeOne, 2500);
        }

        // --- ARREGLOS VISUALES (Mantenidos) ---
        setInterval(() => {
            const dashSpans = Array.from(document.querySelectorAll('span, p, div')).filter(e => e.textContent.trim() === 'Dash');
            let barraMenu = null;
            for (const span of dashSpans) {
                if (span.getBoundingClientRect().top > window.innerHeight - 100) {
                    let cand = span.parentElement;
                    if (cand && cand.parentElement && cand.parentElement.children.length > 4) {
                        barraMenu = cand.parentElement; break;
                    }
                }
            }
            if (barraMenu) {
                Array.from(barraMenu.children).forEach(boton => {
                    boton.style.background = 'transparent'; boton.style.boxShadow = 'none'; boton.style.border = 'none';
                    boton.querySelectorAll('*').forEach(h => { if(h.tagName!='SVG'&&h.tagName!='IMG') h.style.color='white'; });
                    boton.querySelectorAll('svg, img').forEach(i => i.style.filter='brightness(0) invert(1)');
                });
            }
            document.querySelectorAll('div, span, h1, h2').forEach(el => {
                if(el.children.length===0 && el.textContent.trim().length>0 && el.getBoundingClientRect().bottom < 65) {
                    el.style.setProperty('color', '#ffffff', 'important');
                }
            });
            // Matar mensajes de precisi√≥n si aparecen
            document.querySelectorAll('*').forEach(el => {
                if (el.textContent && el.textContent.includes('Mejorando precisi√≥n')) el.style.display = 'none';
            });

        }, 500);
    </script>
</body>
</html>
