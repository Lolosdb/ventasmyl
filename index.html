<!doctype html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./logo_myl.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-title" content="Ventas M&L" />
    <title>Gesti√≥n de Ventas</title>

    <script>
        // Simulamos se√±al GPS fija para que la app no se queje
        const fakePos = { coords: { latitude: 40.4168, longitude: -3.7038, accuracy: 20 }, timestamp: Date.now() };
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition = function(s, e, o) { if(s) s(fakePos); };
            navigator.geolocation.watchPosition = function(s, e, o) { if(s) s(fakePos); return 999; };
        }
    </script>

    <script type="module" crossorigin src="./index-NVVWiGcP.js"></script>
    <link rel="stylesheet" href="./index-cqvvk0bb.css?v=final">
    <link rel="manifest" href="./manifest.webmanifest">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <style>
        /* --- ARREGLO CLAVE: NO ROMPER EL LAYOUT --- */
        /* En lugar de ocultar el mapa original con display:none (que rompe la p√°gina),
           simplemente lo hacemos transparente. As√≠ ocupa su espacio y los botones no se mueven. */
        .leaflet-container:not(#mi-mapa-real) {
            opacity: 0 !important;           /* Invisible */
            pointer-events: none !important; /* No se puede tocar */
            z-index: 0 !important;           /* Al fondo */
        }
        
        /* Ocultar mensaje de precisi√≥n visualmente si aparece */
        div, span, p { 
            /* Si tiene la clase de aviso, se ocultar√° por JS abajo, esto es backup */
        }

        /* ESTILOS DE LA APP ORIGINAL (Para que se vea bien) */
        .euro-menu-fix { font-size: 24px !important; display: inline-block; line-height: 1; transform: translateY(1px); }
        .texto-ventas { text-transform: uppercase !important; font-weight: 700 !important; color: #ffffff !important; }
        .fecha-espanol { font-size: 11px !important; font-weight: 700 !important; color: #94a3b8 !important; margin-bottom: 2px !important; display: block !important; }

        /* --- NUESTRO BOT√ìN Y MAPA --- */
        #btn-lanzar-mapa {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: #2563eb;
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            font-weight: bold;
            font-family: sans-serif;
            z-index: 9999;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.3);
            display: flex; align-items: center; gap: 8px;
        }

        #visor-mapa {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 100000;
        }
        #mi-mapa-real { width: 100%; height: 100%; }
        
        #panel-control {
            position: absolute; top: 15px; right: 15px;
            background: rgba(255,255,255,0.95); padding: 15px;
            border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            z-index: 100001; width: 220px; text-align: center; font-family: sans-serif;
        }
        .btn-cerrar {
            position: absolute; top: -10px; left: -10px; width: 35px; height: 35px;
            background: white; border: 2px solid #ccc; border-radius: 50%;
            font-weight: bold; cursor: pointer; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <div id="btn-lanzar-mapa" onclick="abrirMapa()">
        üåç MAPA
    </div>

    <div id="visor-mapa">
        <div id="panel-control">
            <button class="btn-cerrar" onclick="cerrarMapa()">‚úï</button>
            <h3 style="margin:0 0 10px 0; font-size:15px;">Clientes</h3>
            <div id="info-estado" style="font-size:12px; margin-bottom:10px; color:#555;">Cargando...</div>
            <button onclick="repararUbicaciones()" style="background:#ef4444; color:white; border:none; padding:8px; width:100%; border-radius:6px; cursor:pointer; font-size:12px;">
                ‚ö†Ô∏è Reparar (Borrar todo)
            </button>
        </div>
        <div id="mi-mapa-real"></div>
    </div>

    <script>
        // --- 1. MANTENIMIENTO VISUAL ---
        setInterval(() => {
            // Ocultar mensaje "Mejorando precisi√≥n" por JS (M√°s seguro)
            document.querySelectorAll('div, p, span').forEach(el => {
                if(el.textContent && el.textContent.includes('Mejorando precisi√≥n')) {
                    el.style.display = 'none';
                }
            });

            // Arreglos originales de la app (Texto blanco, Euro, etc)
            // Men√∫
            const dashSpans = Array.from(document.querySelectorAll('span, p, div')).filter(e => e.textContent.trim() === 'Dash');
            let barraMenu = null;
            for (const span of dashSpans) {
                if (span.getBoundingClientRect().top > window.innerHeight - 100) {
                    let cand = span.parentElement;
                    if (cand && cand.parentElement && cand.parentElement.children.length > 4) {
                        barraMenu = cand.parentElement; break;
                    }
                }
            }
            if (barraMenu) {
                Array.from(barraMenu.children).forEach(boton => {
                    boton.style.background = 'transparent'; boton.style.boxShadow = 'none'; boton.style.border = 'none';
                    boton.querySelectorAll('*').forEach(h => { if(h.tagName!='SVG'&&h.tagName!='IMG') h.style.color='white'; });
                    boton.querySelectorAll('svg, img').forEach(i => i.style.filter='brightness(0) invert(1)');
                    if(boton.textContent.includes('‚Ç¨') || boton.innerHTML.includes('‚Ç¨')) {
                         boton.querySelectorAll('*').forEach(x => { if(x.textContent.includes('‚Ç¨')) x.classList.add('euro-menu-fix'); });
                    }
                });
            }
            
            // Header Blanco
            document.querySelectorAll('h1, h2, h3, div, span').forEach(el => {
                if(el.children.length === 0 && el.textContent.trim().length > 0) {
                    const rect = el.getBoundingClientRect();
                    if(rect.top < 65 && rect.bottom > 0 && !el.closest('#visor-mapa')) {
                         const s = window.getComputedStyle(el);
                         if(s.color !== 'rgb(255, 255, 255)') el.style.setProperty('color', '#ffffff', 'important');
                    }
                }
            });
            
            // Textos Ventas
            document.querySelectorAll('*').forEach(el => {
                if (el.children.length === 0 && el.textContent.trim()) {
                    const t = el.textContent.trim().toUpperCase();
                    if ((t.includes("ANUAL") || t.includes("HIST√ìRICO")) && !el.dataset.replaced) {
                        el.textContent = el.textContent.replace(/ANUAL/gi, 'VENTAS').replace(/HIST√ìRICO/gi, 'VENTAS');
                        el.classList.add('texto-ventas');
                        el.dataset.replaced = "true";
                    }
                }
            });

        }, 800);

        // --- 2. L√ìGICA DE NUESTRO MAPA ---
        let map = null;

        function abrirMapa() {
            document.getElementById('visor-mapa').style.display = 'block';
            setTimeout(() => {
                if (!map) {
                    map = L.map('mi-mapa-real').setView([40.4168, -3.7038], 6);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
                }
                map.invalidateSize();
                pintarChinchetas();
            }, 100);
        }

        function cerrarMapa() { document.getElementById('visor-mapa').style.display = 'none'; }

        function repararUbicaciones() {
            if(confirm("¬øResetear todas las ubicaciones y volver a buscar?")) {
                const clients = JSON.parse(localStorage.getItem('clients') || '[]');
                clients.forEach(c => { c.lat = 0; c.lon = 0; });
                localStorage.setItem('clients', JSON.stringify(clients));
                alert("Hecho. Buscando direcciones...");
                location.reload();
            }
        }

        function pintarChinchetas() {
            map.eachLayer(l => { if(l instanceof L.Marker) map.removeLayer(l); });
            try {
                const clients = JSON.parse(localStorage.getItem('clients') || '[]');
                const orders = JSON.parse(localStorage.getItem('orders') || '[]');
                const now = new Date();
                const mesAtras = new Date(); mesAtras.setDate(now.getDate() - 30);
                
                const greenIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', shadowSize: [41, 41] });
                const redIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', shadowSize: [41, 41] });

                let ubicados = 0;
                let pendientes = 0;

                clients.forEach(c => {
                    if (c.lat && c.lon && c.lat !== 0) {
                        ubicados++;
                        let lastOrder = null;
                        const misPedidos = orders.filter(o => o.cliente_id == c.id || (o.cliente && o.cliente.includes(c.name)));
                        if (misPedidos.length > 0) {
                            misPedidos.sort((a,b) => new Date(b.fecha||b.timestamp) - new Date(a.fecha||a.timestamp));
                            lastOrder = new Date(misPedidos[0].fecha||misPedidos[0].timestamp);
                        }
                        const icono = (lastOrder && lastOrder >= mesAtras) ? greenIcon : redIcon;
                        L.marker([c.lat, c.lon], { icon: icono })
                            .bindPopup(`<b>${c.name}</b><br>${c.address||''}<br><small>${lastOrder ? lastOrder.toLocaleDateString() : 'Sin ventas'}</small>`)
                            .addTo(map);
                    } else if(c.address && c.address.length > 3) {
                        pendientes++;
                    }
                });

                document.getElementById('info-estado').innerHTML = `Ubicados: <b>${ubicados}</b><br>Buscando: <b style="color:${pendientes>0?'orange':'green'}">${pendientes}</b>`;
                if(pendientes > 0) buscarSiguiente();

            } catch(e) {}
        }

        async function buscarSiguiente() {
            if (document.getElementById('visor-mapa').style.display === 'none') { setTimeout(buscarSiguiente, 3000); return; }
            
            const clients = JSON.parse(localStorage.getItem('clients') || '[]');
            const target = clients.find(c => (c.address && c.address.length > 4) && (!c.lat || c.lat === 0));

            if (target) {
                document.getElementById('info-estado').innerHTML += `<br><small style="color:blue">Geocod: ${target.name.substring(0,10)}...</small>`;
                try {
                    const query = `${target.address}, ${target.city||''}, Espa√±a`;
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`);
                    if (res.ok) {
                        const data = await res.json();
                        if (data.length > 0) { target.lat = parseFloat(data[0].lat); target.lon = parseFloat(data[0].lon); }
                        else { target.lat = 0.0001; }
                        const idx = clients.findIndex(x => x.id === target.id);
                        if(idx !== -1) clients[idx] = target;
                        localStorage.setItem('clients', JSON.stringify(clients));
                        pintarChinchetas();
                    }
                } catch(e) {}
                setTimeout(buscarSiguiente, 1500);
            }
        }
    </script>
</body>
</html>
