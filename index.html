<!doctype html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./logo_myl.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-title" content="Ventas M&L" />
    <title>Gesti√≥n de Ventas</title>

    <script type="module" crossorigin src="./index-NVVWiGcP.js"></script>
    <link rel="stylesheet" href="./index-cqvvk0bb.css?v=final">
    <link rel="manifest" href="./manifest.webmanifest">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* --- ESTILOS QUIR√öRGICOS --- */

        /* Arreglo S√≠mbolo Euro en Men√∫ */
        .euro-menu-fix {
            font-size: 24px !important;
            display: inline-block;
            line-height: 1;
            transform: translateY(1px);
        }

        /* Textos Ventas */
        .texto-ventas {
            text-transform: uppercase !important;
            font-weight: 700 !important;
            color: #ffffff !important;
        }

        /* Fechas */
        .fecha-espanol {
            font-size: 11px !important;
            font-weight: 700 !important;
            color: #94a3b8 !important;
            margin-bottom: 2px !important;
            display: block !important;
        }
        
        /* Asegurar Mapa visible */
        #custom-leaflet-map {
            z-index: 99999 !important;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script>
        // ==========================================
        // 2. EL ARREGLADOR VISUAL
        // ==========================================
        setInterval(() => {
            
            // --- A. MEN√ö INFERIOR ---
            const dashSpans = Array.from(document.querySelectorAll('span, p, div')).filter(e => e.textContent.trim() === 'Dash');
            let barraMenu = null;
            for (const span of dashSpans) {
                const rect = span.getBoundingClientRect();
                if (rect.top > window.innerHeight - 100) {
                    let candidato = span.parentElement;
                    for (let k = 0; k < 3; k++) {
                        if (candidato && candidato.parentElement) {
                            if (candidato.parentElement.children.length > 4) {
                                barraMenu = candidato.parentElement;
                                break;
                            }
                        }
                        candidato = candidato ? candidato.parentElement : null;
                    }
                }
                if (barraMenu) break;
            }

            if (barraMenu) {
                Array.from(barraMenu.children).forEach(boton => {
                    boton.style.backgroundColor = 'transparent';
                    boton.style.boxShadow = 'none';
                    boton.style.border = 'none';
                    const hijos = boton.querySelectorAll('*');
                    hijos.forEach(hijo => {
                        if (hijo.tagName !== 'SVG' && hijo.tagName !== 'IMG') {
                            hijo.style.color = '#ffffff';
                        }
                        if (hijo.textContent.includes('‚Ç¨') && !hijo.classList.contains('euro-menu-fix')) {
                            hijo.classList.add('euro-menu-fix');
                        }
                    });
                    const iconos = boton.querySelectorAll('svg, img');
                    iconos.forEach(ico => ico.style.filter = 'brightness(0) invert(1)');
                    const estilo = window.getComputedStyle(boton);
                    if (boton.className.includes('active') || estilo.backgroundColor.includes('235') || location.href.includes(boton.textContent.trim().toLowerCase())) {
                        boton.style.borderBottom = '3px solid white';
                        boton.style.paddingBottom = '4px';
                    } else {
                        boton.style.borderBottom = 'none';
                    }
                });
            }

            // --- Ocultar mensaje "Mejorando precisi√≥n" ---
            document.querySelectorAll('div, span, p').forEach(el => {
                if (el.textContent && el.textContent.includes('Mejorando precisi√≥n') && el.style.display !== 'none') {
                    el.style.display = 'none';
                }
            });

            // --- Textos Generales ---
            document.querySelectorAll('*').forEach(el => {
                if (el.children.length === 0 && el.textContent.trim()) {
                    const t = el.textContent.trim().toUpperCase();
                    if (t.includes("ANUAL") || t.includes("HIST√ìRICO") || t.includes("HISTORICO")) {
                        if (!el.dataset.replaced) {
                            el.textContent = el.textContent.replace(/ANUAL/gi, 'VENTAS').replace(/HIST√ìRICO/gi, 'VENTAS').replace(/HISTORICO/gi, 'VENTAS');
                            el.classList.add('texto-ventas');
                            el.dataset.replaced = "true";
                        }
                    }
                    if (t === "MEDIA MENSUAL GLOBAL") el.textContent = "MEDIA ANUAL";
                    if (t === "HIST√ìRICO VENTAS") el.textContent = "Medias mensuales";
                    if (t === "TOTALES" || t === "ULTIMA" || t === "ANUAL") el.style.color = '#ffffff';
                }
            });

            document.querySelectorAll('*').forEach(el => {
                if (el.children.length === 0 && el.textContent.includes(' ‚Ç¨') && !el.classList.contains('euro-menu-fix')) {
                    const s = window.getComputedStyle(el);
                    if (parseFloat(s.fontSize) < 13) {
                        el.style.fontSize = '13px';
                        el.style.fontWeight = '600';
                        el.style.opacity = '0.9';
                    }
                }
            });

            document.querySelectorAll('*').forEach(el => {
                if (el.children.length === 0) {
                    const t = el.textContent.trim();
                    if (/^\d{4}-\d{2}-\d{2}$/.test(t)) {
                        const [y, m, d] = t.split('-');
                        el.textContent = `${d}-${m}-${y}`;
                        el.classList.add('fecha-espanol');
                    }
                }
            });

            document.querySelectorAll('div, span, h1, h2, h3, h4, h5, h6, a, p').forEach(el => {
                if (el.children.length === 0 && el.textContent.trim().length > 0) {
                    const rect = el.getBoundingClientRect();
                    if (rect.top >= 0 && rect.bottom <= 65) {
                        if (rect.width > 0 && rect.height > 0) {
                            el.style.setProperty('color', '#ffffff', 'important');
                        }
                    }
                }
            });

        }, 500);

        // ==========================================
        // 3. SISTEMA DE MAPAS (MODO SEGURO)
        // ==========================================
        (function () {
            console.log("Inicializando sistema de mapas (Safe Mode)...");

            const NOMINATIM_BASE_URL = "https://nominatim.openstreetmap.org/search";
            let mapInstance = null;
            let lastDataSignature = "";

            // --- A. GEOCODIFICADOR AUTOM√ÅTICO ---
            async function autoGeocode() {
                const clientsStr = localStorage.getItem('clients');
                if (!clientsStr) return;
                let clients = [];
                try { clients = JSON.parse(clientsStr); } catch (e) { return; }

                const allPending = clients.filter(c =>
                    (c.address || c.direccion) &&
                    (!c.lat || !c.lon || c.lat === 0 || c.lon === 0)
                );

                // Actualizar status visual
                const statusEl = document.getElementById('geo-status-text');
                if (statusEl) {
                    if (allPending.length > 0) {
                        statusEl.innerHTML = `Localizando... Falta: <b>${allPending.length}</b>`;
                        statusEl.style.color = '#eab308';
                    } else {
                        statusEl.innerHTML = `Todo localizado.`;
                        statusEl.style.color = '#22c55e';
                    }
                }

                const pending = allPending[0];
                if (pending) {
                    const address = pending.address || pending.direccion || "";
                    const city = pending.city || pending.poblacion || "";
                    const province = pending.province || pending.provincia || "";
                    if (!address || address.length < 3) return; 
                    const query = `${address}, ${city}, ${province}, Espa√±a`;

                    try {
                        const res = await fetch(`${NOMINATIM_BASE_URL}?q=${encodeURIComponent(query)}&format=json&limit=1`);
                        if (res.ok) {
                            const data = await res.json();
                            if (data && data.length > 0) {
                                pending.lat = parseFloat(data[0].lat);
                                pending.lon = parseFloat(data[0].lon);
                                const index = clients.findIndex(c => c.id === pending.id);
                                if (index !== -1) {
                                    clients[index] = pending;
                                    localStorage.setItem('clients', JSON.stringify(clients));
                                    reloadMarkers(true);
                                }
                            }
                        }
                    } catch (err) { }
                }
            }
            setInterval(autoGeocode, 2000);

            // --- B. VISTA DE MAPA ---
            function checkMapView() {
                const myMap = document.getElementById('custom-leaflet-map');
                const isMapActive = Array.from(document.querySelectorAll('span, div, p')).some(el =>
                    el.textContent.trim() === 'Mapa' &&
                    (el.classList.contains('active') || el.closest('.active') || el.style.color === 'white' || location.href.includes('map'))
                );

                if (isMapActive) {
                    if (!myMap) {
                        // Crear Overlay con Bot√≥n de Cierre de Seguridad
                        const overlay = document.createElement('div');
                        overlay.id = 'custom-leaflet-map';
                        overlay.style.position = 'fixed';
                        overlay.style.top = '60px';
                        overlay.style.left = '0';
                        overlay.style.width = '100%';
                        overlay.style.height = 'calc(100% - 120px)';
                        overlay.style.zIndex = '99999';
                        overlay.style.backgroundColor = 'white';
                        document.body.appendChild(overlay);

                        // Controles
                        const controls = document.createElement('div');
                        controls.style.cssText = "position:absolute; top:10px; right:10px; z-index:10000; background:rgba(255,255,255,0.95); padding:8px; border-radius:8px; box-shadow:0 4px 6px rgba(0,0,0,0.1); width:180px; text-align:center; font-size:12px;";
                        
                        controls.innerHTML = `
                            <button id="btn-close-map" style="position:absolute; top:-10px; left:-10px; width:30px; height:30px; background:white; border:2px solid #ccc; border-radius:50%; font-weight:bold; cursor:pointer; font-size:16px;">‚úï</button>
                            <div id="geo-status-text" style="margin-bottom:8px; font-weight:600; color:#444;">Iniciando...</div>
                            <button id="btn-reset-geo" style="background:#ef4444; color:white; border:none; padding:5px 10px; border-radius:4px; font-weight:bold; cursor:pointer; width:100%;">
                                üóëÔ∏è Resetear
                            </button>
                        `;
                        overlay.appendChild(controls);

                        // Eventos Controles
                        document.getElementById('btn-close-map').onclick = function() {
                            overlay.style.display = 'none';
                        };

                        document.getElementById('btn-reset-geo').onclick = function() {
                            if(confirm("¬øResetear ubicaciones incorrectas?")) {
                                try {
                                    const c = JSON.parse(localStorage.getItem('clients')||'[]');
                                    c.forEach(x => { if(x.lat && x.lon) { x.lat = 0; x.lon = 0; } });
                                    localStorage.setItem('clients', JSON.stringify(c));
                                    location.reload();
                                } catch(e) { alert("Error: " + e); }
                            }
                        };

                        // RETARDO DE SEGURIDAD PARA INICIAR EL MAPA
                        setTimeout(() => {
                            try {
                                mapInstance = L.map('custom-leaflet-map').setView([40.4168, -3.7038], 6);
                                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                    attribution: '¬© OpenStreetMap'
                                }).addTo(mapInstance);
                                
                                // Cargar chinchetas
                                reloadMarkers(true);
                            } catch(e) {
                                console.error("Error cr√≠tico iniciando mapa:", e);
                                overlay.innerHTML += '<div style="position:absolute;top:50%;width:100%;text-align:center;color:red;">Error al cargar el mapa. Pulsa X para cerrar.</div>';
                            }
                        }, 200);

                    } else {
                        myMap.style.display = 'block';
                        if (mapInstance) {
                             setTimeout(() => { mapInstance.invalidateSize(); }, 100);
                        }
                        reloadMarkers(false);
                    }
                } else {
                    if (myMap) myMap.style.display = 'none';
                }
            }

            function reloadMarkers(force = false) {
                if (!mapInstance) return;

                const clientsStr = localStorage.getItem('clients');
                const ordersStr = localStorage.getItem('orders');
                if (!clientsStr) return;

                const currentDataSig = clientsStr.length + "-" + (ordersStr ? ordersStr.length : 0);
                if (!force && currentDataSig === lastDataSignature) return;
                lastDataSignature = currentDataSig;

                // Limpieza Manual de Chinchetas (Sin usar Cluster)
                mapInstance.eachLayer((layer) => {
                    if (layer instanceof L.Marker) mapInstance.removeLayer(layer);
                });

                try {
                    const clients = JSON.parse(clientsStr);
                    const orders = ordersStr ? JSON.parse(ordersStr) : [];
                    const now = new Date();
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(now.getDate() - 30);

                    const createIcon = (colorUrl) => {
                        return new L.Icon({
                            iconUrl: colorUrl,
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                        });
                    };
                    const greenIcon = createIcon('https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png');
                    const redIcon = createIcon('https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png');

                    clients.forEach(c => {
                        if (c.lat && c.lon && (c.lat !== 0 || c.lon !== 0)) {
                            let lastOrderDate = null;
                            const clientOrders = orders.filter(o =>
                                o.cliente_id == c.id || o.client_code == c.code || (o.cliente && o.cliente.includes(c.name))
                            );
                            if (clientOrders.length > 0) {
                                clientOrders.sort((a, b) => new Date(b.timestamp || b.fecha) - new Date(a.timestamp || a.fecha));
                                if (clientOrders[0].timestamp || clientOrders[0].fecha) lastOrderDate = new Date(clientOrders[0].timestamp || clientOrders[0].fecha);
                            }

                            const marker = L.marker([c.lat, c.lon], { 
                                icon: (lastOrderDate && lastOrderDate >= thirtyDaysAgo) ? greenIcon : redIcon 
                            });

                            marker.bindPopup(`<b>${c.name||'Cliente'}</b><br>${c.address||''}`);
                            marker.addTo(mapInstance);
                        }
                    });
                } catch (e) { console.error("Error pintando chinchetas:", e); }
            }

            setInterval(checkMapView, 500);
        })();
    </script>
</body>

</html>
