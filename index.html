<!doctype html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./logo_myl.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Gesti√≥n de Ventas</title>

    <script>
        const fakePos = { coords: { latitude: 40.4168, longitude: -3.7038, accuracy: 20 }, timestamp: Date.now() };
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition = (s, e, o) => { if(s) s(fakePos); };
            navigator.geolocation.watchPosition = (s, e, o) => { if(s) s(fakePos); return 999; };
        }
    </script>

    <script type="module" crossorigin src="./index-NVVWiGcP.js"></script>
    <link rel="stylesheet" href="./index-cqvvk0bb.css?v=final">
    <link rel="manifest" href="./manifest.webmanifest">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* ESTILOS DE LA APP */
        body { margin: 0; background-color: #1e293b; font-family: system-ui, -apple-system, sans-serif; }
        .leaflet-container:not(#mi-mapa-real) { opacity: 0 !important; pointer-events: none !important; z-index: 0 !important; }
        
        /* Ocultar elementos molestos */
        .euro-menu-fix { font-size: 24px !important; display: inline-block; transform: translateY(1px); }
        .texto-ventas { text-transform: uppercase !important; font-weight: 700 !important; color: #ffffff !important; }
        
        /* BOT√ìN FLOTANTE AZUL (Men√∫ Principal) */
        #btn-menu-flotante {
            position: fixed; bottom: 90px; right: 20px;
            background: #2563eb; color: white;
            padding: 12px 20px; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            font-weight: bold; cursor: pointer; z-index: 9999;
            border: 2px solid rgba(255,255,255,0.3);
            display: flex; align-items: center; gap: 10px;
        }

        /* VISOR DE MAPA Y HERRAMIENTAS */
        #visor-general {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: white; z-index: 100000;
        }

        /* PANEL DE CONTROL SUPERIOR */
        #panel-control {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.98); padding: 15px;
            border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 100001; width: 90%; max-width: 450px;
            display: flex; flex-direction: column; gap: 10px;
        }

        /* Botones del Panel */
        .btn-accion {
            padding: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 13px;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;
        }
        .btn-importar { background: #15803d; color: white; } /* Verde */
        .btn-reset { background: #ef4444; color: white; } /* Rojo */
        
        /* Input File Oculto */
        #input-excel { display: none; }

        /* Barra de Progreso */
        .progress-box { background: #f3f4f6; padding: 10px; border-radius: 8px; margin-top: 5px; }
        .progress-text { font-size: 12px; color: #333; display: flex; justify-content: space-between; margin-bottom: 5px; }
        .progress-bar-bg { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: #2563eb; width: 0%; transition: width 0.3s; }

        /* Bot√≥n Cerrar */
        .btn-cerrar {
            position: absolute; top: 10px; right: 10px; width: 32px; height: 32px;
            background: white; border: 1px solid #ccc; border-radius: 50%;
            font-size: 18px; cursor: pointer; z-index: 100002; display: flex; align-items: center; justify-content: center;
        }

        #mi-mapa-real { width: 100%; height: 100%; }
    </style>
</head>

<body>
    <div id="root"></div>

    <div id="btn-menu-flotante" onclick="abrirVisor()">
        üåç MAPA & IMPORTAR
    </div>

    <div id="visor-general">
        <button class="btn-cerrar" onclick="cerrarVisor()">‚úï</button>
        
        <div id="panel-control">
            <div style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:5px;">
                <h3 style="margin:0 0 5px 0; font-size:14px; color:#333;">Gesti√≥n de Clientes</h3>
                <input type="file" id="input-excel" accept=".xlsx, .xls, .csv" onchange="procesarExcel(this)" />
                <button class="btn-accion btn-importar" onclick="document.getElementById('input-excel').click()">
                    üìÇ Importar Excel (Auto-Coords)
                </button>
                <div style="font-size:10px; color:#666; margin-top:4px;">* Usa columnas: DIRECCION, POBLACION, PROVINCIA</div>
            </div>

            <div class="progress-box">
                <div class="progress-text">
                    <span id="estado-txt">Esperando archivo...</span>
                    <span id="contador-txt">0/0</span>
                </div>
                <div class="progress-bar-bg">
                    <div id="barra-progreso" class="progress-bar-fill"></div>
                </div>
            </div>

            <button class="btn-accion btn-reset" onclick="borrarTodo()" style="margin-top:5px; font-size:11px; padding:6px;">
                üóëÔ∏è Borrar datos y empezar de cero
            </button>
        </div>

        <div id="mi-mapa-real"></div>
    </div>

    <script>
        // --- 1. CONFIGURACI√ìN Y MANTENIMIENTO ---
        setInterval(() => {
            // Ocultar textos molestos
            document.querySelectorAll('div, p, span').forEach(el => {
                if(el.textContent && el.textContent.includes('Mejorando precisi√≥n')) el.style.display = 'none';
            });
            // Arreglos Visuales App Original
            document.querySelectorAll('h1, h2, div, span').forEach(el => {
                if(el.textContent.trim().length > 0 && el.getBoundingClientRect().top < 65 && !el.closest('#visor-general')) {
                     const s = window.getComputedStyle(el);
                     if(s.color !== 'rgb(255, 255, 255)') el.style.setProperty('color', '#ffffff', 'important');
                }
            });
            const menus = document.querySelectorAll('div'); // Buscar men√∫ inferior para iconos blancos
            menus.forEach(d => {
                if(d.style.position === 'fixed' && d.style.bottom === '0px') {
                     d.querySelectorAll('svg, img').forEach(i => i.style.filter='brightness(0) invert(1)');
                     d.querySelectorAll('span').forEach(s => s.style.color='white');
                }
            });
        }, 1000);

        // --- 2. L√ìGICA DE MAPA ---
        let map = null;
        function abrirVisor() {
            document.getElementById('visor-general').style.display = 'block';
            setTimeout(() => {
                if (!map) {
                    map = L.map('mi-mapa-real').setView([40.4168, -3.7038], 6);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
                }
                map.invalidateSize();
                pintarMapa();
            }, 200);
        }
        function cerrarVisor() { document.getElementById('visor-general').style.display = 'none'; }
        function borrarTodo() {
            if(confirm("¬øSeguro que quieres borrar TODOS los clientes de la memoria?")) {
                localStorage.setItem('clients', '[]');
                alert("Datos borrados.");
                location.reload();
            }
        }

        // --- 3. IMPORTADOR INTELIGENTE DE EXCEL ---
        async function procesarExcel(input) {
            const file = input.files[0];
            if (!file) return;

            document.getElementById('estado-txt').innerText = "Leyendo archivo...";
            document.getElementById('barra-progreso').style.width = "5%";

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    if (jsonData.length === 0) { alert("El Excel parece vac√≠o."); return; }

                    // Convertir formato Excel al formato App
                    let nuevosClientes = jsonData.map((row, index) => {
                        return {
                            id: row.CODIGO || row.ID || index,
                            code: row.CODIGO || '',
                            name: row.TIENDA || row.NOMBRE || 'Sin Nombre',
                            address: row.DIRECCION || '',
                            city: row.POBLACION || '',
                            province: row.PROVINCIA || '',
                            lat: 0, // Pendiente de calcular
                            lon: 0  // Pendiente de calcular
                        };
                    });

                    // Guardar inicial
                    localStorage.setItem('clients', JSON.stringify(nuevosClientes));
                    
                    alert(`‚úÖ Archivo le√≠do: ${nuevosClientes.length} clientes.\nüöÄ Iniciando b√∫squeda de coordenadas...`);
                    
                    pintarMapa(); // Mostrar pines (aunque est√©n en 0,0)
                    iniciarGeocodificacionMasiva(); // Arrancar el motor

                } catch (err) {
                    alert("Error leyendo el Excel: " + err.message);
                    console.error(err);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- 4. MOTOR DE GEOCODIFICACI√ìN (Con Cola de Espera) ---
        async function iniciarGeocodificacionMasiva() {
            const clients = JSON.parse(localStorage.getItem('clients') || '[]');
            let pendientes = clients.filter(c => (c.address && c.address.length > 3) && (!c.lat || c.lat === 0));
            let total = clients.length;
            let procesados = total - pendientes.length;

            actualizarBarra(procesados, total, "Buscando coordenadas...");

            // Procesar uno a uno
            for (let i = 0; i < clients.length; i++) {
                let c = clients[i];
                
                // Si falta ubicaci√≥n y tiene direcci√≥n -> BUSCAR
                if ((!c.lat || c.lat === 0) && c.address && c.address.length > 3) {
                    
                    actualizarBarra(procesados, total, `Buscando: ${c.name.substring(0,15)}...`);
                    
                    // Intentar geocodificar
                    let coords = await buscarCoordenadas(c.address, c.city, c.province);
                    
                    if (coords) {
                        clients[i].lat = coords.lat;
                        clients[i].lon = coords.lon;
                    } else {
                        clients[i].lat = 0.0001; // Marca de "No encontrado" para no reintentar
                    }
                    
                    // Guardar progreso cada vez (por si se cierra)
                    localStorage.setItem('clients', JSON.stringify(clients));
                    procesados++;
                    
                    // Refrescar mapa visualmente
                    if (coords) pintarMapa();

                    // ESPERA OBLIGATORIA (1.2 segundos para no ser bloqueados)
                    await new Promise(r => setTimeout(r, 1200));
                }
            }
            
            actualizarBarra(total, total, "‚úÖ Importaci√≥n Completada");
            alert("¬°Proceso finalizado! Todos los clientes han sido procesados.");
        }

        async function buscarCoordenadas(direccion, ciudad, provincia) {
            try {
                const query = `${direccion}, ${ciudad || ''}, ${provincia || ''}, Espa√±a`;
                //console.log("Consultando API:", query);
                const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`;
                
                const res = await fetch(url);
                if (res.ok) {
                    const data = await res.json();
                    if (data.length > 0) {
                        return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                    }
                }
            } catch (e) {
                console.warn("Error red:", e);
            }
            return null; // Fallo
        }

        function actualizarBarra(actual, total, texto) {
            const porc = total > 0 ? Math.round((actual / total) * 100) : 0;
            document.getElementById('barra-progreso').style.width = `${porc}%`;
            document.getElementById('contador-txt').innerText = `${actual}/${total}`;
            document.getElementById('estado-txt').innerText = texto;
        }

        function pintarMapa() {
            if(!map) return;
            map.eachLayer(l => { if(l instanceof L.Marker) map.removeLayer(l); });

            const clients = JSON.parse(localStorage.getItem('clients') || '[]');
            const orders = JSON.parse(localStorage.getItem('orders') || '[]'); // Por si acaso hay pedidos
            
            const greenIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', shadowSize: [41, 41] });
            const redIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', shadowSize: [41, 41] });

            clients.forEach(c => {
                if (c.lat && c.lon && c.lat !== 0 && c.lat !== 0.0001) {
                    L.marker([c.lat, c.lon], { icon: redIcon })
                        .bindPopup(`<b>${c.name}</b><br>${c.address}<br>${c.city}`)
                        .addTo(map);
                }
            });
        }
    </script>
</body>
</html>
