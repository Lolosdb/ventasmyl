<!doctype html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./logo_myl.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Gesti√≥n de Ventas</title>

    <script>
        // Simulamos un GPS fijo para que la app original no se vuelva loca buscando se√±al
        const fakePosition = {
            coords: { latitude: 40.4168, longitude: -3.7038, accuracy: 50 },
            timestamp: Date.now()
        };
        navigator.geolocation.getCurrentPosition = (cb) => cb(fakePosition);
        navigator.geolocation.watchPosition = (cb) => { cb(fakePosition); return 0; };
    </script>

    <script type="module" crossorigin src="./index-NVVWiGcP.js"></script>
    <link rel="stylesheet" href="./index-cqvvk0bb.css?v=final">
    <link rel="manifest" href="./manifest.webmanifest">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <style>
        /* ESTILOS GENERALES */
        body { background-color: #1e293b; margin: 0; overflow: hidden; }

        /* OCULTAR ELEMENTOS MOLESTOS DE LA APP ORIGINAL */
        /* Ocultamos cualquier contenedor que parezca un mapa de la app antigua */
        .leaflet-container:not(#mi-mapa-real) { display: none !important; }
        /* Ocultamos mensajes de aviso */
        div:contains("Mejorando precisi√≥n") { display: none !important; }

        /* ARREGLOS VISUALES DE LA APP (Textos blancos, etc) */
        .texto-ventas { text-transform: uppercase !important; font-weight: 700 !important; color: white !important; }
        .euro-menu-fix { font-size: 24px !important; display: inline-block; transform: translateY(1px); }

        /* --- NUESTRO SISTEMA DE MAPA PROPIO --- */
        
        /* Bot√≥n Flotante para abrir el mapa */
        #btn-lanzar-mapa {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: #2563eb;
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            font-weight: bold;
            font-family: sans-serif;
            z-index: 9999;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Contenedor Pantalla Completa del Mapa */
        #visor-mapa {
            display: none; /* Oculto por defecto */
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: white;
            z-index: 100000;
        }

        /* El div donde se dibuja el mapa */
        #mi-mapa-real { width: 100%; height: 100%; }

        /* Panel de Control dentro del mapa */
        #panel-control {
            position: absolute;
            top: 15px; right: 15px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            z-index: 100001;
            width: 200px;
            text-align: center;
            font-family: sans-serif;
        }

        /* Bot√≥n Cerrar */
        .btn-cerrar {
            position: absolute; top: -10px; left: -10px;
            width: 35px; height: 35px;
            background: white; border: 2px solid #ccc;
            border-radius: 50%; font-weight: bold;
            cursor: pointer; font-size: 16px;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <div id="btn-lanzar-mapa" onclick="abrirMapa()">
        üåç MAPA CLIENTES
    </div>

    <div id="visor-mapa">
        <div id="panel-control">
            <button class="btn-cerrar" onclick="cerrarMapa()">‚úï</button>
            <h3 style="margin:0 0 10px 0; font-size:16px;">Mapa de Clientes</h3>
            <div id="info-estado" style="font-size:12px; margin-bottom:10px; color:#555;">Cargando...</div>
            <button onclick="repararUbicaciones()" style="background:#ef4444; color:white; border:none; padding:8px; width:100%; border-radius:6px; cursor:pointer; font-size:12px;">
                ‚ö†Ô∏è Reparar Ubicaciones
            </button>
        </div>
        <div id="mi-mapa-real"></div>
    </div>

    <script>
        // --- 1. L√ìGICA DEL MAPA ---
        let map = null;

        function abrirMapa() {
            document.getElementById('visor-mapa').style.display = 'block';
            
            // Iniciamos Leaflet con un peque√±o retardo para asegurar que el DIV ya es visible
            setTimeout(() => {
                if (!map) {
                    map = L.map('mi-mapa-real').setView([40.4168, -3.7038], 6);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap'
                    }).addTo(map);
                } else {
                    map.invalidateSize(); // Ajustar tama√±o si ya exist√≠a
                }
                pintarChinchetas();
            }, 100);
        }

        function cerrarMapa() {
            document.getElementById('visor-mapa').style.display = 'none';
        }

        function repararUbicaciones() {
            if(confirm("¬øQuieres borrar las posiciones actuales y volver a buscarlas por direcci√≥n?")) {
                const clients = JSON.parse(localStorage.getItem('clients') || '[]');
                clients.forEach(c => { c.lat = 0; c.lon = 0; });
                localStorage.setItem('clients', JSON.stringify(clients));
                alert("Datos reiniciados. El mapa buscar√° las direcciones de nuevo.");
                location.reload();
            }
        }

        function pintarChinchetas() {
            // Limpiar pines anteriores
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) map.removeLayer(layer);
            });

            try {
                const clients = JSON.parse(localStorage.getItem('clients') || '[]');
                const orders = JSON.parse(localStorage.getItem('orders') || '[]');
                
                // Iconos
                const createIcon = (url) => L.icon({
                    iconUrl: url, iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', shadowSize: [41, 41]
                });
                const greenIcon = createIcon('https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png');
                const redIcon = createIcon('https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png');

                let ubicados = 0;
                let pendientes = 0;
                const now = new Date();
                const mesAtras = new Date(); mesAtras.setDate(now.getDate() - 30);

                clients.forEach(c => {
                    if (c.lat && c.lon && c.lat !== 0) {
                        ubicados++;
                        // L√≥gica √öltimo Pedido
                        let ultimoPedido = null;
                        const misPedidos = orders.filter(o => o.cliente_id == c.id || (o.cliente && o.cliente.includes(c.name)));
                        if (misPedidos.length > 0) {
                            misPedidos.sort((a,b) => new Date(b.fecha||b.timestamp) - new Date(a.fecha||a.timestamp));
                            ultimoPedido = new Date(misPedidos[0].fecha||misPedidos[0].timestamp);
                        }

                        const icono = (ultimoPedido && ultimoPedido >= mesAtras) ? greenIcon : redIcon;
                        
                        L.marker([c.lat, c.lon], { icon: icono })
                            .bindPopup(`<b>${c.name}</b><br>${c.address || ''}<br><small>${ultimoPedido ? '√öltimo: '+ultimoPedido.toLocaleDateString() : 'Sin ventas recientes'}</small>`)
                            .addTo(map);
                    } else {
                        if(c.address && c.address.length > 3) pendientes++;
                    }
                });

                document.getElementById('info-estado').innerHTML = `
                    <span style="color:green">‚óè</span> Ubicados: <b>${ubicados}</b><br>
                    <span style="color:orange">‚óè</span> Pendientes: <b>${pendientes}</b>
                `;

                if (pendientes > 0) buscarSiguientePendiente();

            } catch (e) { console.error(e); }
        }

        // --- 2. BUSCADOR AUTOM√ÅTICO (Uno a uno) ---
        async function buscarSiguientePendiente() {
            // Solo buscar si el mapa est√° abierto (ahorro bater√≠a)
            if (document.getElementById('visor-mapa').style.display === 'none') {
                setTimeout(buscarSiguientePendiente, 2000); return;
            }

            const clients = JSON.parse(localStorage.getItem('clients') || '[]');
            const target = clients.find(c => (c.address && c.address.length > 4) && (!c.lat || c.lat === 0));

            if (target) {
                document.getElementById('info-estado').innerHTML = `Buscando GPS para:<br><b>${target.name.substring(0,15)}...</b>`;
                
                try {
                    const query = `${target.address}, ${target.city||''}, Espa√±a`;
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`);
                    if (res.ok) {
                        const data = await res.json();
                        if (data.length > 0) {
                            target.lat = parseFloat(data[0].lat);
                            target.lon = parseFloat(data[0].lon);
                        } else {
                            target.lat = 0.0001; // Marcar como no encontrado
                        }
                        // Guardar
                        const idx = clients.findIndex(x => x.id === target.id);
                        if (idx !== -1) clients[idx] = target;
                        localStorage.setItem('clients', JSON.stringify(clients));
                        
                        pintarChinchetas(); // Actualizar mapa
                    }
                } catch(e) {}
                setTimeout(buscarSiguientePendiente, 1500); // Esperar 1.5s entre b√∫squedas
            } else {
                document.getElementById('info-estado').innerHTML = "‚úÖ Todos procesados";
            }
        }

        // --- 3. MANTENIMIENTO VISUAL (Bucle suave) ---
        setInterval(() => {
            // Arreglos de texto blanco en cabeceras
            document.querySelectorAll('h1, h2, h3, div, span').forEach(el => {
                const style = window.getComputedStyle(el);
                if (el.getBoundingClientRect().top < 60 && style.color !== 'rgb(255, 255, 255)' && el.innerText.trim().length > 0) {
                    if(!el.closest('#visor-mapa')) el.style.color = 'white'; // No tocar nuestro mapa
                }
            });
            // Euro
            document.querySelectorAll('*').forEach(el => {
                if(el.textContent.includes('‚Ç¨') && !el.classList.contains('euro-menu-fix')) el.classList.add('euro-menu-fix');
            });
        }, 1000);

    </script>
</body>
</html>
