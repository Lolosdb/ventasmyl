<!doctype html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./logo_myl.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Gesti√≥n de Ventas</title>

    <script>
        const fakePos = { coords: { latitude: 40.4168, longitude: -3.7038, accuracy: 50 }, timestamp: Date.now() };
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition = (s) => s(fakePos);
            navigator.geolocation.watchPosition = (s) => { s(fakePos); return 999; };
        }
    </script>

    <script type="module" crossorigin src="./index-NVVWiGcP.js"></script>
    <link rel="stylesheet" href="./index-cqvvk0bb.css?v=final">
    <link rel="manifest" href="./manifest.webmanifest">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { margin: 0; background-color: #1e293b; font-family: sans-serif; overflow: hidden; }
        .leaflet-container:not(#mi-mapa-real) { opacity: 0 !important; pointer-events: none !important; z-index: 0 !important; }
        .texto-ventas { text-transform: uppercase !important; font-weight: 700 !important; color: #ffffff !important; }
        .euro-menu-fix { font-size: 24px !important; display: inline-block; transform: translateY(1px); }

        /* VISOR MAPA */
        #visor-mapa { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1e293b; z-index: 900; }
        #mi-mapa-real { width: 100%; height: 100%; }

        /* BOTONES */
        .btn-mapa {
            position: absolute; top: 20px; background: white; color: #333;
            padding: 8px 16px; border-radius: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            font-weight: bold; font-size: 13px; cursor: pointer; z-index: 1001; display: flex; align-items: center; gap: 6px; border: 1px solid #ccc;
        }
        #btn-salir { left: 15px; }
        #btn-opciones { right: 15px; background: #2563eb; color: white; border: none; }

        /* PANEL OPCIONES */
        #panel-importar {
            position: absolute; top: 65px; right: 15px; width: 280px;
            background: rgba(255,255,255,0.98); border-radius: 12px; padding: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.4); z-index: 1002;
            transform: translateX(130%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 85vh; overflow-y: auto;
        }
        #panel-importar.activo { transform: translateX(0); }
        
        .btn-accion { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .btn-verde { background: #16a34a; color: white; }
        .btn-rojo { background: #fee2e2; color: #ef4444; border: 1px solid #fca5a5; }
        .btn-naranja { background: #f59e0b; color: white; margin-top: 20px; box-shadow: 0 4px 10px rgba(245, 158, 11, 0.4); }
        
        #resultado-espia {
            margin-top: 10px; background: #1e293b; color: #00ff00; 
            font-family: monospace; font-size: 10px; padding: 10px; 
            border-radius: 5px; white-space: pre-wrap; display: none;
            max-height: 200px; overflow-y: auto;
        }

        #input-excel { display: none; }
        nav, div[style*="bottom: 0"], div[class*="bottom"] { z-index: 9999 !important; position: fixed !important; }
    </style>
</head>

<body>
    <div id="root"></div>

    <div id="visor-mapa">
        <div id="btn-salir" class="btn-mapa" onclick="cerrarMapa()">‚¨ÖÔ∏è Volver</div>
        <div id="btn-opciones" class="btn-mapa" onclick="toggleImportar()">üìÇ Opciones</div>

        <div id="panel-importar">
            <h4 style="margin:0 0 10px 0; border-bottom:1px solid #eee; padding-bottom:5px;">Configuraci√≥n</h4>
            <div style="font-size:11px; color:#555; margin-bottom:10px;">
                Carga el archivo <b>Clientes_CON_COORDENADAS.xlsx</b>
            </div>
            <input type="file" id="input-excel" accept=".xlsx,.xls" onchange="cargarExcel(this)">
            <button class="btn-accion btn-verde" onclick="document.getElementById('input-excel').click()">Subir Excel</button>
            <button class="btn-accion btn-rojo" onclick="borrarDatos()">Borrar Mapa</button>
            
            <button class="btn-accion btn-naranja" onclick="espiarDatos()">üïµÔ∏è ESPIAR DATOS</button>
            <div id="resultado-espia"></div>
            
            <div style="margin-top:10px; text-align:center; font-size:10px; color:#999; cursor:pointer;" onclick="toggleImportar()">Cerrar</div>
        </div>

        <div id="mi-mapa-real"></div>
    </div>

    <script>
        // 1. CONTROL DE PANTALLA
        setInterval(() => {
            let mapaActivo = false;
            document.querySelectorAll('a, div, span, p').forEach(el => {
                const txt = el.textContent ? el.textContent.trim().toLowerCase() : '';
                if (txt === 'mapa' || txt === 'map') {
                    const style = window.getComputedStyle(el);
                    if (el.className.includes('active') || style.color === 'rgb(255, 255, 255)' || style.color === 'rgb(37, 99, 235)') mapaActivo = true;
                }
            });
            if (window.location.href.includes('/map')) mapaActivo = true;

            const visor = document.getElementById('visor-mapa');
            if (mapaActivo) {
                if (visor.style.display !== 'block') {
                    visor.style.display = 'block';
                    if (!map) iniciarMapa();
                    else { map.invalidateSize(); pintarPuntos(); }
                }
            } else {
                if (visor.style.display !== 'none') {
                    visor.style.display = 'none';
                    document.getElementById('panel-importar').classList.remove('activo');
                }
            }
            // Limpieza visual
            document.querySelectorAll('div,p,span').forEach(e => { if(e.textContent.includes('Mejorando precisi√≥n')) e.style.display='none'; });
            document.querySelectorAll('div').forEach(d => {
                const r = d.getBoundingClientRect();
                if(d.style.position === 'fixed' && r.bottom >= window.innerHeight) {
                     d.style.zIndex = "9999"; d.querySelectorAll('svg, img').forEach(i => i.style.filter='brightness(0) invert(1)');
                }
            });
        }, 500);

        // 2. MAPA
        let map = null;
        function iniciarMapa() {
            map = L.map('mi-mapa-real', { zoomControl: false }).setView([40.4168, -3.7038], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            pintarPuntos();
        }
        function cerrarMapa() {
            if(window.history.length > 1) window.history.back();
            else { const btn = Array.from(document.querySelectorAll('span, p, div')).find(e => e.textContent.trim() === 'Dash'); if(btn) btn.click(); }
            document.getElementById('visor-mapa').style.display = 'none';
        }
        function toggleImportar() { document.getElementById('panel-importar').classList.toggle('activo'); }
        function borrarDatos() { if(confirm("¬øBorrar?")) { localStorage.setItem('clients', '[]'); location.reload(); } }

        function cargarExcel(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const nuevos = json.map((row, i) => {
                    const get = (k) => row[k] || row[k.toUpperCase()] || "";
                    return {
                        id: get('CODIGO') || i,
                        name: get('TIENDA') || get('NOMBRE') || "Cliente",
                        address: get('DIRECCION'), city: get('POBLACION'),
                        lat: parseFloat(get('LATITUD') || 0), lon: parseFloat(get('LONGITUD') || 0)
                    };
                });
                const validos = nuevos.filter(c => c.lat !== 0);
                if (validos.length === 0) { alert("‚ö†Ô∏è Archivo sin coordenadas. Usa Python primero."); return; }
                localStorage.setItem('clients', JSON.stringify(nuevos));
                alert(`‚úÖ ${validos.length} clientes cargados.`);
                toggleImportar(); pintarPuntos();
            };
            reader.readAsArrayBuffer(file);
        }

        // 3. FUNCI√ìN DETECTIVE (LO IMPORTANTE AHORA)
        function espiarDatos() {
            const div = document.getElementById('resultado-espia');
            div.style.display = 'block';
            div.innerText = "üîç ESCANEANDO MEMORIA DEL NAVEGADOR...\n----------------------------\n";
            
            let encontradoAlgo = false;
            
            // Recorrer todo el almacenamiento LocalStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const valor = localStorage.getItem(key);
                
                // Mostrar solo las claves, y si son largas, un resumen
                let resumen = valor.length > 50 ? valor.substring(0, 50) + "..." : valor;
                
                // Si parece una lista de pedidos, lo marcamos
                let esSospechoso = "";
                if (valor.includes('"fecha"') || valor.includes('"date"') || valor.includes('"pedido"') || valor.includes('"total"')) {
                    esSospechoso = " <--- ¬°POSIBLE CANDIDATO!";
                }

                div.innerText += `üì¶ [${key}]: ${resumen}${esSospechoso}\n`;
                encontradoAlgo = true;
            }

            if(!encontradoAlgo) div.innerText += "‚ö†Ô∏è La memoria est√° vac√≠a. ¬øQuiz√°s usa IndexedDB?";
            
            alert("Mira la lista negra que ha aparecido. ¬øVes alg√∫n nombre como 'orders', 'ventas', 'data', 'firebase'?");
        }

        // 4. PINTAR (Usando el nombre que encontremos)
        function pintarPuntos() {
            if(!map) return;
            map.eachLayer(l => { if(l instanceof L.Marker) map.removeLayer(l); });
            
            const clients = JSON.parse(localStorage.getItem('clients') || '[]');
            
            // ‚ö†Ô∏è AQU√ç EST√Å EL TRUCO: INTENTAMOS LEER TODO LO QUE PAREZCA UN PEDIDO
            let orders = [];
            // Intento 1: 'orders'
            try { orders = orders.concat(JSON.parse(localStorage.getItem('orders')||'[]')); } catch(e){}
            // Intento 2: Buscar claves que contengan 'order' o 'venta'
            for(let i=0; i<localStorage.length; i++) {
                const k = localStorage.key(i);
                if(k!=='orders' && (k.includes('order') || k.includes('venta') || k.includes('pedidos'))) {
                    try { 
                        const d = JSON.parse(localStorage.getItem(k));
                        if(Array.isArray(d)) orders = orders.concat(d);
                    } catch(e){}
                }
            }
            
            const greenIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', shadowSize:[41,41] });
            const redIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', shadowSize:[41,41] });

            const now = new Date();
            const limite30dias = new Date();
            limite30dias.setDate(now.getDate() - 30);
            const norm = (s) => s ? s.toString().toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim() : "";

            const bounds = [];
            clients.forEach(c => {
                if(c.lat && c.lon && c.lat !== 0) {
                    const cName = norm(c.name);
                    const misPedidos = orders.filter(o => {
                        const oName = norm(o.cliente || o.client_name || o.nombre || "");
                        return oName === cName || (cName.length > 4 && oName.includes(cName));
                    });

                    let lastOrderDate = null;
                    if(misPedidos.length > 0) {
                        misPedidos.sort((a,b) => new Date(b.fecha || b.timestamp) - new Date(a.fecha || a.timestamp));
                        const raw = misPedidos[0].fecha || misPedidos[0].timestamp;
                        if(raw) lastOrderDate = new Date(raw);
                    }

                    let icono = redIcon;
                    if (lastOrderDate && !isNaN(lastOrderDate) && lastOrderDate >= limite30dias) {
                        icono = greenIcon;
                    }

                    L.marker([c.lat, c.lon], {icon: icono})
                        .bindPopup(`<b>${c.name}</b><br>${c.address}<br><div style="margin-top:5px; padding:3px; color:white; font-size:11px; font-weight:bold; border-radius:4px; background:${icono === greenIcon ? '#16a34a' : '#ef4444'}">${lastOrderDate ? lastOrderDate.toLocaleDateString() : 'Sin Pedidos'}</div>`)
                        .addTo(map);
                    bounds.push([c.lat, c.lon]);
                }
            });
            if (bounds.length > 0) map.fitBounds(bounds);
        }
    </script>
</body>
</html>
