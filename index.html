<!doctype html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./logo_myl.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Gesti√≥n de Ventas</title>

    <script type="module" crossorigin src="./index-NVVWiGcP.js"></script>
    <link rel="stylesheet" href="./index-cqvvk0bb.css?v=final">
    <link rel="manifest" href="./manifest.webmanifest">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* --- ESTILOS GENERALES --- */
        body { 
            margin: 0; background-color: #1e293b; font-family: sans-serif; 
            overflow-x: hidden !important; overflow-y: auto !important; 
            padding-bottom: 120px !important; 
        }

        .leaflet-container:not(#mi-mapa-real) { opacity: 0 !important; pointer-events: none !important; z-index: 0 !important; }
        .texto-ventas { text-transform: uppercase !important; font-weight: 700 !important; color: #ffffff !important; }
        
        /* VISOR MAPA */
        #visor-mapa { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1e293b; z-index: 10000; }
        #mi-mapa-real { width: 100%; height: 100%; }

        /* BOTONES MAPA */
        .btn-mapa { position: absolute; top: 20px; background: white; color: #333; padding: 8px 16px; border-radius: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-weight: bold; font-size: 13px; cursor: pointer; z-index: 10001; display: flex; align-items: center; gap: 6px; border: 1px solid #ccc; }
        #btn-salir { left: 15px; }
        #btn-opciones { right: 15px; background: #2563eb; color: white; border: none; }

        /* PANEL IMPORTAR */
        #panel-importar { position: absolute; top: 65px; right: 15px; width: 280px; background: rgba(255,255,255,0.98); border-radius: 12px; padding: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.4); z-index: 10002; transform: translateX(130%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); max-height:80vh; overflow-y:auto; }
        #panel-importar.activo { transform: translateX(0); }
        
        /* BOTONES */
        .btn-accion { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .btn-verde { background: #16a34a; color: white; }
        .btn-rojo { background: #fee2e2; color: #ef4444; border: 1px solid #fca5a5; }
        .btn-naranja { background: #f97316; color: white; border:1px solid #ea580c; }
        
        /* BOT√ìN REPARAR */
        #btn-reparar-inyectado {
            width: 100%; padding: 12px; margin-top: 15px; 
            border-radius: 8px; border: none; cursor: pointer; 
            font-weight: bold; background: #f97316; color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-transform: uppercase; font-size: 12px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        /* L√ÅPIZ FLOTANTE */
        #btn-editar-flotante {
            position: fixed; bottom: 80px; right: 20px;
            width: 56px; height: 56px; border-radius: 50%;
            background: #2563eb; color: white;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
            display: none; align-items: center; justify-content: center;
            font-size: 24px; cursor: pointer; z-index: 99999;
            border: 2px solid white;
        }
        #btn-editar-flotante:active { transform: scale(0.9); }

        /* MODAL EDITOR */
        #modal-editor {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 100000;
            overflow-y: auto;
        }
        .editor-content {
            background: white; width: 90%; max-width: 400px; margin: 40px auto;
            border-radius: 12px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
        }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 11px; color: #666; margin-bottom: 5px; font-weight: bold; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        
        .coord-row { display: flex; gap: 10px; align-items: center; }
        
        /* NUEVO BOT√ìN GPS */
        .btn-gps {
            background: #0ea5e9; color: white; border: none;
            border-radius: 6px; padding: 0 15px; height: 38px;
            font-weight: bold; cursor: pointer; white-space: nowrap;
            display: flex; align-items: center; gap: 5px; font-size: 12px;
        }
        .btn-gps:active { background: #0284c7; }

        #input-excel { display: none; }
        nav, div[style*="bottom: 0"], div[class*="bottom"] { z-index: 9999 !important; position: fixed !important; }
    </style>
</head>

<body>
    <div id="root"></div>

    <div id="btn-editar-flotante" onclick="abrirEditor()">‚úèÔ∏è</div>

    <div id="modal-editor">
        <div class="editor-content">
            <h3 style="margin:0 0 15px 0; color:#1e293b;">Editar Cliente</h3>
            
            <input type="hidden" id="edit-id">
            
            <div class="form-group">
                <label class="form-label">NOMBRE</label>
                <input type="text" id="edit-name" class="form-input">
            </div>
            
            <div class="form-group">
                <label class="form-label">DIRECCI√ìN</label>
                <input type="text" id="edit-address" class="form-input">
            </div>

            <div class="form-group">
                <label class="form-label">TEL√âFONO</label>
                <input type="text" id="edit-phone" class="form-input">
            </div>

            <div class="form-group">
                <label class="form-label">EMAIL</label>
                <input type="text" id="edit-email" class="form-input">
            </div>

            <div class="form-group">
                <label class="form-label">NOTAS</label>
                <textarea id="edit-notes" class="form-input" rows="3"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">UBICACI√ìN GPS</label>
                <div class="coord-row">
                    <input type="number" id="edit-lat" class="form-input" placeholder="Latitud">
                    <input type="number" id="edit-lon" class="form-input" placeholder="Longitud">
                    <button class="btn-gps" onclick="capturarGPSPropio()">üìç GPS AQU√ç</button>
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-accion btn-rojo" onclick="cerrarEditor()">Cancelar</button>
                <button class="btn-accion btn-verde" onclick="guardarEdicion()">üíæ GUARDAR</button>
            </div>
        </div>
    </div>

    <div id="visor-mapa">
        <div id="btn-salir" class="btn-mapa" onclick="cerrarMapa()">‚¨ÖÔ∏è Volver</div>
        <div id="btn-opciones" class="btn-mapa" onclick="toggleImportar()">üìÇ Opciones</div>

        <div id="panel-importar">
            <h4 style="margin:0 0 10px 0; border-bottom:1px solid #eee; padding-bottom:5px;">Herramientas</h4>
            <div style="font-size:11px; color:#555; margin-bottom:5px;">Carga <i>Clientes_CON_COORDENADAS.xlsx</i></div>
            <input type="file" id="input-excel" accept=".xlsx,.xls" onchange="cargarExcel(this)">
            <button class="btn-accion btn-verde" onclick="document.getElementById('input-excel').click()">Subir Excel Mapa</button>
            <button class="btn-accion btn-naranja" onclick="repararBaseDatos()">üõ†Ô∏è REPARAR DATOS</button>
            <button class="btn-accion btn-rojo" onclick="borrarDatos()" style="margin-top:20px;">Borrar Mapa</button>
            <div style="margin-top:10px; text-align:center; font-size:10px; color:#999; cursor:pointer;" onclick="toggleImportar()">Cerrar</div>
        </div>

        <div id="mi-mapa-real"></div>
    </div>

    <script>
        let clienteEnEdicion = null;

        // 1. INTERVALO MAESTRO
        setInterval(() => {
            let mapaActivo = false;
            document.querySelectorAll('a, div, span, p').forEach(el => {
                const txt = el.textContent ? el.textContent.trim().toLowerCase() : '';
                if (txt === 'mapa' || txt === 'map') {
                    const style = window.getComputedStyle(el);
                    if (el.className.includes('active') || style.color === 'rgb(255, 255, 255)' || style.color === 'rgb(37, 99, 235)') mapaActivo = true;
                }
            });
            if (window.location.href.includes('/map')) mapaActivo = true;

            const visor = document.getElementById('visor-mapa');
            if (mapaActivo) {
                if (visor.style.display !== 'block') {
                    visor.style.display = 'block';
                    document.body.style.overflow = 'hidden'; 
                    if (!map) iniciarMapa(); else { map.invalidateSize(); pintarPuntos(); }
                }
            } else {
                if (visor.style.display !== 'none') {
                    visor.style.display = 'none';
                    document.body.style.overflow = 'auto'; 
                    document.getElementById('panel-importar').classList.remove('activo');
                }
            }

            document.querySelectorAll('div,p,span').forEach(e => { if(e.textContent.includes('Mejorando precisi√≥n')) e.style.display='none'; });
            document.querySelectorAll('div').forEach(d => {
                const r = d.getBoundingClientRect();
                if(d.style.position === 'fixed' && r.bottom >= window.innerHeight) { d.style.zIndex = "9999"; d.querySelectorAll('svg, img').forEach(i => i.style.filter='brightness(0) invert(1)'); }
            });

            // Scroll Modal
            document.querySelectorAll('div, h1, h2, h3, span').forEach(el => {
                if (el.textContent && el.textContent.trim() === "Editar Pedido") {
                    let modal = el.closest('div[style*="position: fixed"]') || el.closest('div[style*="z-index"]');
                    if(modal) { modal.style.setProperty('overflow-y','auto','important'); modal.style.setProperty('max-height','90vh','important'); modal.style.setProperty('padding-bottom','50px','important'); }
                }
            });

            // Bot√≥n Reparar
            const botonesTexto = document.querySelectorAll('div, button, label, span');
            let botonOriginal = null;
            botonesTexto.forEach(el => { if (el.textContent && el.textContent.trim() === "Seleccionar Archivo" && el.offsetParent !== null) botonOriginal = el; });

            if (botonOriginal) {
                let contenedor = botonOriginal.parentElement;
                while(contenedor && contenedor.tagName !== 'DIV' && !contenedor.className.includes('card')) { contenedor = contenedor.parentElement; }
                if(!contenedor) contenedor = botonOriginal.parentElement.parentElement;
                if (contenedor && !document.getElementById('btn-reparar-inyectado')) {
                    const btn = document.createElement('div');
                    btn.id = 'btn-reparar-inyectado';
                    btn.innerHTML = 'üõ†Ô∏è REPARAR FICHA BLANCA';
                    btn.onclick = function() { repararBaseDatos(); };
                    contenedor.appendChild(btn);
                }
            }

            detectarClienteEnPantalla();
        }, 500);

        // --- FUNCIONES DEL EDITOR ---

        function detectarClienteEnPantalla() {
            const btn = document.getElementById('btn-editar-flotante');
            if(document.getElementById('visor-mapa').style.display === 'block') { btn.style.display = 'none'; return; }

            const titulos = document.querySelectorAll('h1, h2, h3, div[class*="title"], span[class*="title"]');
            const clientes = JSON.parse(localStorage.getItem('clients') || '[]');
            
            let encontrado = null;
            for (let el of titulos) {
                const texto = el.textContent ? el.textContent.trim().toUpperCase() : "";
                if(texto.length > 3) {
                    const match = clientes.find(c => (c.name || "").toUpperCase() === texto);
                    if(match) { encontrado = match; break; }
                }
            }

            if(encontrado) {
                btn.style.display = 'flex';
                clienteEnEdicion = encontrado;
            } else {
                btn.style.display = 'none';
            }
        }

        function abrirEditor() {
            if(!clienteEnEdicion) return;
            document.getElementById('edit-id').value = clienteEnEdicion.id || "";
            document.getElementById('edit-name').value = clienteEnEdicion.name || "";
            document.getElementById('edit-address').value = clienteEnEdicion.address || "";
            document.getElementById('edit-phone').value = clienteEnEdicion.phone || "";
            document.getElementById('edit-email').value = clienteEnEdicion.email || "";
            document.getElementById('edit-notes').value = clienteEnEdicion.notes || "";
            document.getElementById('edit-lat').value = clienteEnEdicion.lat || 0;
            document.getElementById('edit-lon').value = clienteEnEdicion.lon || 0;
            document.getElementById('modal-editor').style.display = 'block';
        }

        // *** NUEVA FUNCI√ìN CAPTURAR GPS ***
        function capturarGPSPropio() {
            if (!navigator.geolocation) { alert("Tu navegador no soporta GPS."); return; }
            
            const latField = document.getElementById('edit-lat');
            const lonField = document.getElementById('edit-lon');
            const btn = document.querySelector('.btn-gps');
            const textoOriginal = btn.innerHTML;

            btn.innerHTML = "‚è≥ Buscando...";
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    latField.value = lat;
                    lonField.value = lon;
                    alert(`‚úÖ Posici√≥n capturada:\nLat: ${lat.toFixed(5)}\nLon: ${lon.toFixed(5)}`);
                    btn.innerHTML = textoOriginal;
                },
                (error) => {
                    alert("‚ùå Error al obtener GPS. Aseg√∫rate de dar permisos a la web.");
                    console.error(error);
                    btn.innerHTML = textoOriginal;
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function cerrarEditor() { document.getElementById('modal-editor').style.display = 'none'; }

        function guardarEdicion() {
            const id = document.getElementById('edit-id').value;
            const clientes = JSON.parse(localStorage.getItem('clients') || '[]');
            const index = clientes.findIndex(c => String(c.id) === String(id));
            if(index === -1) { alert("Error al guardar."); return; }

            const c = clientes[index];
            c.name = document.getElementById('edit-name').value;
            c.address = document.getElementById('edit-address').value;
            c.phone = document.getElementById('edit-phone').value;
            c.email = document.getElementById('edit-email').value;
            c.notes = document.getElementById('edit-notes').value;
            c.lat = parseFloat(document.getElementById('edit-lat').value) || 0;
            c.lon = parseFloat(document.getElementById('edit-lon').value) || 0;

            c.nombre = c.name; c.direccion = c.address; c.telefono = c.phone; c.correo = c.email; c.notas = c.notes;

            clientes[index] = c;
            localStorage.setItem('clients', JSON.stringify(clientes));
            alert("‚úÖ Cliente actualizado con √©xito.");
            location.reload(); 
        }

        // --- FUNCIONES MAPA ---
        let map = null;
        function iniciarMapa() {
            map = L.map('mi-mapa-real', { zoomControl: false }).setView([43.36, -5.85], 8);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            pintarPuntos();
        }
        function cerrarMapa() {
            document.getElementById('visor-mapa').style.display = 'none'; document.body.style.overflow = 'auto';
            const b = Array.from(document.querySelectorAll('span,p,div,a')).find(e => e.textContent.trim() === 'Dash'); if(b) b.click();
        }
        function toggleImportar() { document.getElementById('panel-importar').classList.toggle('activo'); }
        function borrarDatos() { if(confirm("¬øBorrar?")) { localStorage.setItem('clients', '[]'); location.reload(); } }

        function cargarExcel(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const nuevos = json.map((row, i) => {
                    const get = (k) => { const f = Object.keys(row).find(x => x.toUpperCase().trim()===k); return f?row[f]:""; };
                    const clean = (v) => v ? parseFloat(v.toString().replace(',','.')) || 0 : 0;
                    return {
                        id: get('CODIGO') || i,
                        name: get('TIENDA') || get('NOMBRE') || "Cliente",
                        address: get('DIRECCION'), city: get('POBLACION'),
                        lat: clean(get('LATITUD')), lon: clean(get('LONGITUD'))
                    };
                });
                localStorage.setItem('clients', JSON.stringify(nuevos));
                alert(`‚úÖ Mapa actualizado: ${nuevos.length} clientes.`);
                toggleImportar(); pintarPuntos();
            };
            reader.readAsArrayBuffer(file);
        }

        function repararBaseDatos() {
            try {
                const rawData = localStorage.getItem('clients');
                if(!rawData || rawData === '[]') { alert("No hay clientes."); return; }
                let clientes = JSON.parse(rawData);
                let reparados = 0;
                clientes = clientes.map(c => {
                    const safe = (val) => (val === undefined || val === null) ? "" : String(val);
                    c.name = safe(c.name || c.nombre || c.tienda || c.cliente || "Sin Nombre");
                    c.address = safe(c.address || c.direccion);
                    c.city = safe(c.city || c.poblacion);
                    c.phone = safe(c.phone || c.telefono);
                    c.email = safe(c.email || c.correo);
                    c.notes = safe(c.notes || c.notas);
                    if(!c.id) c.id = "FIX-" + Math.floor(Math.random()*1000000);
                    c.nombre = c.name; c.direccion = c.address; c.telefono = c.phone; c.correo = c.email;
                    reparados++; return c;
                });
                localStorage.setItem('clients', JSON.stringify(clientes));
                alert(`‚úÖ Reparados ${reparados} clientes.`);
                location.reload(); 
            } catch (e) { alert("Error: " + e.message); }
        }

        function pintarPuntos() {
            if(!map) return;
            map.eachLayer(l => { if(l instanceof L.Marker) map.removeLayer(l); });
            const clients = JSON.parse(localStorage.getItem('clients') || '[]');
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const greenIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', iconSize:[15,24], iconAnchor:[7,24], popupAnchor:[1,-24], shadowUrl:null });
            const redIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize:[15,24], iconAnchor:[7,24], popupAnchor:[1,-24], shadowUrl:null });
            const now = new Date(); const limit = new Date(); limit.setDate(now.getDate()-30);
            
            const grupos = {}; 
            clients.forEach(c => { if(c.lat && c.lon) { const k=`${c.lat}_${c.lon}`; if(!grupos[k]) grupos[k]=[]; grupos[k].push(c); }});
            
            const bounds = [];
            for(const k in grupos) {
                const g = grupos[k];
                let verde = false;
                let html = `<div style="text-align:center;max-height:200px;overflow-y:auto;">`;
                
                g.forEach((c,i) => {
                    const norm = (s) => s ? s.toString().toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim() : "";
                    const cName = norm(c.name);
                    const mis = orders.filter(o => {
                        const oName = norm(o.clientName || o.client_name || o.cliente || "");
                        return (oName && cName && (oName.includes(cName) || cName.includes(oName)));
                    });
                    let last = null;
                    if(mis.length){
                        mis.sort((a,b)=> new Date(b.date||b.fecha||0) - new Date(a.date||a.fecha||0));
                        last = new Date(mis[0].date||mis[0].fecha);
                    }
                    const isV = (last && !isNaN(last) && last >= limit);
                    if(isV) verde = true;
                    if(i>0) html+='<hr style="margin:5px 0;border-top:1px solid #eee">';
                    html+=`<div><b>${c.name}</b><br><span style="font-size:10px">${c.address}</span><br><span style="font-size:10px;background:${isV?'#16a34a':'#ef4444'};color:white;padding:2px 4px;border-radius:3px">${last?last.toLocaleDateString():'Sin Pedidos'}</span></div>`;
                });
                html+='</div>';
                L.marker([g[0].lat, g[0].lon], {icon: verde?greenIcon:redIcon}).bindPopup(html).addTo(map);
                bounds.push([g[0].lat, g[0].lon]);
            }
            if(bounds.length) map.fitBounds(bounds);
        }
    </script>
</body>
</html>
