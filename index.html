<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./logo_MyL.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Ventas M&L" />
    <title>Gestión de Ventas</title>
    
    <script type="module" crossorigin src="./index-NVVWiGcP.js"></script>
    <link rel="stylesheet" crossorigin href="./index-cqvvk0bb.css">
    
    <link rel="manifest" href="./manifest.webmanifest">
    <script id="vite-plugin-pwa:register-sw" src="./borrar_registerSW.js"></script>
  </head>
  <body>
    <div id="root"></div>

    <script>
      (function() {
        // NOMBRE DE LA COPIA DE SEGURIDAD (Memoria paralela)
        const BACKUP_KEY = 'mentaylimon_backup_years'; 

        // Función principal que protege tus datos
        function protectYears() {
          try {
            // 1. Buscamos dónde está guardando los datos la app
            Object.keys(localStorage).forEach(function(key) {
              const raw = localStorage.getItem(key);
              
              // Verificamos si esta caja tiene los datos de la app (busca "years" y corchetes)
              if (raw && raw.indexOf('years')!== -1 && raw.indexOf('[')!== -1) {
                
                // Intentamos leer los datos
                var data;
                try {
                    data = JSON.parse(raw);
                } catch(e) {
                    return; // Si el dato está corrupto, lo ignoramos
                }
                
                if (data.years && Array.isArray(data.years)) {
                  let years = data.years;
                  let modified = false;

                  // 2. RECUPERAR DATOS DE LA COPIA DE SEGURIDAD
                  // Si el usuario ya creó años (ej. 2027) y la app los borró, los recuperamos aquí
                  const backupRaw = localStorage.getItem(BACKUP_KEY);
                  if (backupRaw) {
                    try {
                        const backupYears = JSON.parse(backupRaw);
                        if (Array.isArray(backupYears)) {
                            backupYears.forEach(function(y) {
                                // Si el backup tiene un año que falta en la app, lo devolvemos
                                if (!years.includes(y)) {
                                    years.push(y);
                                    modified = true;
                                    console.log("Guardián: Año restaurado -> " + y);
                                }
                            });
                        }
                    } catch(e) {}
                  }

                  // 3. ASEGURAR SIEMPRE EL 2026 (Mínimo obligatorio solicitado)
                  if (!years.includes(2026)) {
                    years.push(2026);
                    modified = true;
                    console.log("Guardián: Año 2026 inyectado.");
                  }

                  // 4. GUARDAR CORRECCIONES EN LA APP (Si hubo cambios)
                  if (modified) {
                    years.sort(function(a, b) { return b - a; }); // Ordenar descendente (2027, 2026...)
                    data.years = years;
                    localStorage.setItem(key, JSON.stringify(data));
                  }

                  // 5. ACTUALIZAR LA COPIA DE SEGURIDAD
                  // Guardamos la lista completa actual para protegerla de futuros reinicios
                  localStorage.setItem(BACKUP_KEY, JSON.stringify(years));
                }
              }
            });
            
            // Forzar selección del año 2026 si no hay nada seleccionado
            if (!localStorage.getItem('selectedYear')) {
                localStorage.setItem('selectedYear', '2026');
            }
            
          } catch (e) {
            // Silencio en caso de error para no detener la app
          }
        }

        // EJECUCIÓN:
        // 1. Ejecutar inmediatamente al cargar
        protectYears();

        // 2. Ejecutar cada segundo (1000ms) para vigilar si la app intenta borrar los datos al refrescar
        setInterval(protectYears, 1000);
        
      })();
    </script>
  </body>
</html>
