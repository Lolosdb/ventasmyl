<!doctype html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./logo_myl.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Gesti√≥n de Ventas</title>

    <script>
        const fakePos = { coords: { latitude: 40.4168, longitude: -3.7038, accuracy: 50 }, timestamp: Date.now() };
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition = (s) => s(fakePos);
            navigator.geolocation.watchPosition = (s) => { s(fakePos); return 999; };
        }
    </script>

    <script type="module" crossorigin src="./index-NVVWiGcP.js"></script>
    <link rel="stylesheet" href="./index-cqvvk0bb.css?v=final">
    <link rel="manifest" href="./manifest.webmanifest">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* ESTILOS APP */
        body { margin: 0; background-color: #1e293b; font-family: sans-serif; }
        .leaflet-container:not(#mi-mapa-real) { opacity: 0 !important; pointer-events: none !important; z-index: 0 !important; }
        
        /* Arreglos Visuales */
        .euro-menu-fix { font-size: 24px !important; display: inline-block; transform: translateY(1px); }
        .texto-ventas { text-transform: uppercase !important; font-weight: 700 !important; color: #ffffff !important; }

        /* BOT√ìN FLOTANTE */
        #btn-lanzar-mapa {
            position: fixed; bottom: 90px; right: 20px;
            background: #2563eb; color: white;
            padding: 12px 20px; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            font-weight: bold; cursor: pointer; z-index: 9999;
            border: 2px solid rgba(255,255,255,0.3);
            display: flex; align-items: center; gap: 8px;
        }

        /* VISOR PANTALLA COMPLETA */
        #visor-mapa {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: white; z-index: 100000;
        }
        #mi-mapa-real { width: 100%; height: 100%; }

        /* PANEL DE CONTROL */
        #panel-control {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.98); padding: 20px;
            border-radius: 16px; box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            z-index: 100001; width: 90%; max-width: 400px;
            text-align: center;
        }

        /* Indicador de Librer√≠a */
        #status-lib {
            font-size: 11px; margin-bottom: 10px; padding: 4px; border-radius: 4px;
            background: #f3f4f6; color: #666; display: inline-block;
        }
        
        /* Botones */
        .btn-grande {
            width: 100%; padding: 14px; border: none; border-radius: 10px;
            font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            margin-bottom: 8px; font-size: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn-azul { background: #2563eb; color: white; }
        .btn-azul:active { background: #1d4ed8; transform: scale(0.98); }
        .btn-rojo { background: white; color: #ef4444; border: 2px solid #ef4444; margin-top: 15px; }

        .btn-cerrar {
            position: absolute; top: 10px; right: 10px; width: 35px; height: 35px;
            background: #f3f4f6; border: none; border-radius: 50%; 
            cursor: pointer; font-weight: bold; font-size: 18px; color: #333;
        }
        
        /* Barra de Progreso */
        #area-progreso { display: none; margin-top: 15px; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .barra-bg { width: 100%; height: 10px; background: #e2e8f0; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .barra-fill { height: 100%; background: #2563eb; width: 0%; transition: width 0.3s; }

        #input-excel { display: none; }
    </style>
</head>

<body>
    <div id="root"></div>

    <div id="btn-lanzar-mapa" onclick="window.abrirMapa()">
        üåç MAPA & IMPORTAR
    </div>

    <div id="visor-mapa">
        <button class="btn-cerrar" onclick="window.cerrarMapa()">‚úï</button>
        
        <div id="panel-control">
            <h3 style="margin:0 0 5px 0;">Importador de Clientes</h3>
            <div id="status-lib">Iniciando sistema...</div>
            
            <input type="file" id="input-excel" accept=".xlsx, .xls, .csv" onchange="window.procesarArchivo(this)" />
            
            <button class="btn-grande btn-azul" onclick="document.getElementById('input-excel').click()">
                üìÇ SELECCIONAR ARCHIVO
            </button>
            <div style="font-size:11px; color:#555; margin-bottom:10px;">
                Columnas requeridas: Tienda (B), Direcci√≥n (E), Pob (G), Prov (H)
            </div>

            <div id="area-progreso">
                <div style="display:flex; justify-content:space-between; font-size:13px; font-weight:bold;">
                    <span id="txt-estado">Preparado</span>
                    <span id="txt-contador">0/0</span>
                </div>
                <div class="barra-bg"><div id="barra-progreso" class="barra-fill"></div></div>
                <div id="txt-debug" style="font-size:10px; color:#64748b; margin-top:5px; text-align:left; overflow:hidden; white-space:nowrap;"></div>
            </div>

            <button class="btn-grande btn-rojo" onclick="window.borrarDatos()">
                üóëÔ∏è Borrar todo
            </button>
        </div>
        <div id="mi-mapa-real"></div>
    </div>

    <script>
        // --- 1. MANTENIMIENTO VISUAL ---
        setInterval(() => {
            document.querySelectorAll('div, p, span').forEach(el => {
                if(el.textContent && el.textContent.includes('Mejorando precisi√≥n')) el.style.display = 'none';
            });
            const menus = document.querySelectorAll('div');
            menus.forEach(d => {
                if(d.style.position === 'fixed' && d.style.bottom === '0px') {
                     d.querySelectorAll('svg, img').forEach(i => i.style.filter='brightness(0) invert(1)');
                }
            });
            document.querySelectorAll('h1, h2, h3, div, span').forEach(el => {
                if(el.textContent.trim().length > 0 && el.getBoundingClientRect().top < 65 && !el.closest('#visor-mapa')) {
                     const s = window.getComputedStyle(el);
                     if(s.color !== 'rgb(255, 255, 255)') el.style.setProperty('color', '#ffffff', 'important');
                }
            });
        }, 1000);

        // --- 2. VERIFICACI√ìN Y FUNCIONES GLOBALES ---
        
        // Funci√≥n para abrir el mapa y verificar librer√≠a
        window.abrirMapa = function() {
            document.getElementById('visor-mapa').style.display = 'block';
            
            // Verificar si XLSX carg√≥
            const libStatus = document.getElementById('status-lib');
            if (typeof XLSX !== 'undefined') {
                libStatus.innerHTML = "üü¢ Librer√≠a Excel: ACTIVA";
                libStatus.style.color = "green";
            } else {
                libStatus.innerHTML = "üî¥ ERROR: Librer√≠a Excel NO cargada.<br>Revisa tu conexi√≥n.";
                libStatus.style.color = "red";
            }

            setTimeout(() => {
                if (!window.map) {
                    window.map = L.map('mi-mapa-real').setView([40.4168, -3.7038], 6);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(window.map);
                }
                window.map.invalidateSize();
                window.pintarMapa();
            }, 200);
        };

        window.cerrarMapa = function() { document.getElementById('visor-mapa').style.display = 'none'; };
        
        window.borrarDatos = function() {
            if(confirm("¬øEst√°s seguro de borrar todos los clientes?")) {
                localStorage.setItem('clients', '[]');
                alert("Datos eliminados.");
                location.reload();
            }
        };

        // --- 3. PROCESADOR DE ARCHIVO ---
        window.procesarArchivo = function(input) {
            const file = input.files[0];
            if (!file) {
                alert("No seleccionaste ning√∫n archivo.");
                return;
            }

            // Verificar librer√≠a antes de empezar
            if (typeof XLSX === 'undefined') {
                alert("Error Cr√≠tico: La librer√≠a 'XLSX' no se ha podido cargar. Intenta recargar la p√°gina.");
                return;
            }

            // Mostrar UI
            document.getElementById('area-progreso').style.display = 'block';
            document.getElementById('txt-estado').innerText = "Leyendo archivo...";
            document.getElementById('barra-progreso').style.width = "10%";

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    // Leemos como matriz (Array de Arrays)
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    if (!rows || rows.length < 2) {
                        alert("El archivo parece vac√≠o o solo tiene cabecera.");
                        return;
                    }

                    let count = 0;
                    let clientesNuevos = [];

                    // Iterar filas (saltando la 0 que es cabecera)
                    // COLUMNAS: A=0, B=1, C=2, D=3, E=4, F=5, G=6, H=7
                    for (let i = 1; i < rows.length; i++) {
                        const r = rows[i];
                        if (!r || r.length < 2) continue;

                        const nombre = r[1] ? String(r[1]).trim() : ""; // Columna B (Tienda)
                        const direccion = r[4] ? String(r[4]).trim() : ""; // Columna E (Direcci√≥n)
                        
                        // Solo importamos si tiene Nombre Y Direcci√≥n
                        if (nombre && direccion) {
                            clientesNuevos.push({
                                id: (r[0] ? String(r[0]) : "GEN-"+i),
                                name: nombre,
                                address: direccion,
                                city: r[6] ? String(r[6]).trim() : "", // Columna G
                                province: r[7] ? String(r[7]).trim() : "", // Columna H
                                lat: 0, 
                                lon: 0
                            });
                            count++;
                        }
                    }

                    if (count === 0) {
                        alert("No he encontrado clientes v√°lidos.\nAseg√∫rate que 'TIENDA' est√° en Columna B y 'DIRECCI√ìN' en Columna E.");
                        return;
                    }

                    // Guardar
                    localStorage.setItem('clients', JSON.stringify(clientesNuevos));
                    alert(`‚úÖ ¬°Le√≠do con √©xito!\n${count} clientes encontrados.\n\nPulsa ACEPTAR para empezar a buscar sus coordenadas en el mapa.`);
                    
                    window.pintarMapa();
                    window.procesarColaGPS(); // Iniciar b√∫squeda

                } catch (error) {
                    alert("Error leyendo el archivo Excel: " + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        };

        // --- 4. MOTOR GPS (Bucle Seguro) ---
        window.procesarColaGPS = async function() {
            const clients = JSON.parse(localStorage.getItem('clients') || '[]');
            // Filtrar pendientes (lat=0 o lat nula)
            // IGNORAMOS lat=0.0001 (ya procesados y no encontrados)
            const pendientes = clients.filter(c => (!c.lat || c.lat === 0));
            const total = clients.length;
            const hechos = total - pendientes.length;

            // Actualizar UI
            const porc = Math.round((hechos / total) * 100);
            document.getElementById('barra-progreso').style.width = `${porc}%`;
            document.getElementById('txt-contador').innerText = `${hecos}/${total}`;

            if (pendientes.length === 0) {
                document.getElementById('txt-estado').innerText = "‚úÖ Finalizado";
                document.getElementById('txt-debug').innerText = "Todos los clientes procesados.";
                return;
            }

            const target = pendientes[0];
            document.getElementById('txt-estado').innerText = "Geocodificando...";
            document.getElementById('txt-debug').innerText = `>> ${target.name} (${target.city})`;

            let latFound = 0.0001; // Default: No encontrado
            let lonFound = 0.0001;

            try {
                // Limpiar direcci√≥n (quitar comillas, coger antes de la coma)
                let dirLimpia = target.address.replace(/['"]/g, "").split(",")[0];
                let query = `${dirLimpia}, ${target.city}, ${target.province}, Espa√±a`;
                
                // Fetch Nominatim
                let res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`);
                if (res.ok) {
                    let data = await res.json();
                    if (data.length > 0) {
                        latFound = parseFloat(data[0].lat);
                        lonFound = parseFloat(data[0].lon);
                    } else {
                        // Fallback: Probar solo Ciudad
                        let res2 = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(target.city + ", " + target.province + ", Espa√±a")}&format=json&limit=1`);
                        if (res2.ok) {
                            let data2 = await res2.json();
                            if (data2.length > 0) {
                                latFound = parseFloat(data2[0].lat);
                                lonFound = parseFloat(data2[0].lon);
                            }
                        }
                    }
                }
            } catch(e) {
                console.log("Error Red/API");
            }

            // ACTUALIZAR Y GUARDAR
            const indexReal = clients.findIndex(c => c.id === target.id);
            if (indexReal !== -1) {
                clients[indexReal].lat = latFound;
                clients[indexReal].lon = lonFound;
                localStorage.setItem('clients', JSON.stringify(clients));
            }

            // Si encontr√≥ algo v√°lido (>1), repintar mapa
            if (latFound > 1) window.pintarMapa();

            // REPETIR (Con retardo de 1s)
            setTimeout(window.procesarColaGPS, 1000);
        };

        // --- 5. PINTAR MAPA ---
        window.pintarMapa = function() {
            if(!window.map) return;
            window.map.eachLayer(l => { if(l instanceof L.Marker) window.map.removeLayer(l); });

            const clients = JSON.parse(localStorage.getItem('clients') || '[]');
            const greenIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', shadowSize:[41,41] });
            const redIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', shadowSize:[41,41] });

            clients.forEach(c => {
                if (c.lat && c.lon && c.lat > 1) { // Ignorar 0.0001
                    L.marker([c.lat, c.lon], { icon: redIcon })
                        .bindPopup(`<div style="text-align:center"><b>${c.name}</b><br>${c.address}<br><small>${c.city}</small></div>`)
                        .addTo(window.map);
                }
            });
        };
    </script>
</body>
</html>
