<!doctype html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./logo_myl.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-title" content="Ventas M&L" />
    <title>Gesti√≥n de Ventas</title>

    <script type="module" crossorigin src="./index-NVVWiGcP.js"></script>
    <link rel="stylesheet" href="./index-cqvvk0bb.css?v=final">
    <link rel="manifest" href="./manifest.webmanifest">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* --- ESTILOS QUIR√öRGICOS --- */

        /* 2. Arreglo S√≠mbolo Euro en Men√∫ */
        .euro-menu-fix {
            font-size: 24px !important;
            display: inline-block;
            line-height: 1;
            transform: translateY(1px);
        }

        /* 3. Textos Ventas */
        .texto-ventas {
            text-transform: uppercase !important;
            font-weight: 700 !important;
            color: #ffffff !important;
        }

        /* 4. Fechas */
        .fecha-espanol {
            font-size: 11px !important;
            font-weight: 700 !important;
            color: #94a3b8 !important;
            margin-bottom: 2px !important;
            display: block !important;
        }
        
        /* 5. Asegurar Mapa visible */
        #custom-leaflet-map {
            z-index: 99999 !important;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script>
        // ==========================================
        // 2. EL ARREGLADOR VISUAL
        // ==========================================
        setInterval(() => {
            
            // --- A. MEN√ö INFERIOR ---
            const dashSpans = Array.from(document.querySelectorAll('span, p, div')).filter(e => e.textContent.trim() === 'Dash');
            let barraMenu = null;
            for (const span of dashSpans) {
                const rect = span.getBoundingClientRect();
                if (rect.top > window.innerHeight - 100) {
                    let candidato = span.parentElement;
                    for (let k = 0; k < 3; k++) {
                        if (candidato && candidato.parentElement) {
                            if (candidato.parentElement.children.length > 4) {
                                barraMenu = candidato.parentElement;
                                break;
                            }
                        }
                        candidato = candidato ? candidato.parentElement : null;
                    }
                }
                if (barraMenu) break;
            }

            if (barraMenu) {
                Array.from(barraMenu.children).forEach(boton => {
                    boton.style.backgroundColor = 'transparent';
                    boton.style.boxShadow = 'none';
                    boton.style.border = 'none';
                    const hijos = boton.querySelectorAll('*');
                    hijos.forEach(hijo => {
                        if (hijo.tagName !== 'SVG' && hijo.tagName !== 'IMG') {
                            hijo.style.color = '#ffffff';
                        }
                        if (hijo.textContent.includes('‚Ç¨') && !hijo.classList.contains('euro-menu-fix')) {
                            hijo.classList.add('euro-menu-fix');
                        }
                    });
                    const iconos = boton.querySelectorAll('svg, img');
                    iconos.forEach(ico => ico.style.filter = 'brightness(0) invert(1)');
                    const estilo = window.getComputedStyle(boton);
                    if (boton.className.includes('active') || estilo.backgroundColor.includes('235') || location.href.includes(boton.textContent.trim().toLowerCase())) {
                        boton.style.borderBottom = '3px solid white';
                        boton.style.paddingBottom = '4px';
                    } else {
                        boton.style.borderBottom = 'none';
                    }
                });
            }

            // --- Ocultar mensaje "Mejorando precisi√≥n" ---
            document.querySelectorAll('div, span, p').forEach(el => {
                if (el.textContent && el.textContent.includes('Mejorando precisi√≥n') && el.style.display !== 'none') {
                    el.style.display = 'none';
                }
            });

            // --- Textos Generales ---
            document.querySelectorAll('*').forEach(el => {
                if (el.children.length === 0 && el.textContent.trim()) {
                    const t = el.textContent.trim().toUpperCase();
                    if (t.includes("ANUAL") || t.includes("HIST√ìRICO") || t.includes("HISTORICO")) {
                        if (!el.dataset.replaced) {
                            el.textContent = el.textContent.replace(/ANUAL/gi, 'VENTAS').replace(/HIST√ìRICO/gi, 'VENTAS').replace(/HISTORICO/gi, 'VENTAS');
                            el.classList.add('texto-ventas');
                            el.dataset.replaced = "true";
                        }
                    }
                    if (t === "MEDIA MENSUAL GLOBAL") el.textContent = "MEDIA ANUAL";
                    if (t === "HIST√ìRICO VENTAS") el.textContent = "Medias mensuales";
                    if (t === "TOTALES" || t === "ULTIMA" || t === "ANUAL") el.style.color = '#ffffff';
                }
            });

            document.querySelectorAll('*').forEach(el => {
                if (el.children.length === 0 && el.textContent.includes(' ‚Ç¨') && !el.classList.contains('euro-menu-fix')) {
                    const s = window.getComputedStyle(el);
                    if (parseFloat(s.fontSize) < 13) {
                        el.style.fontSize = '13px';
                        el.style.fontWeight = '600';
                        el.style.opacity = '0.9';
                    }
                }
            });

            document.querySelectorAll('*').forEach(el => {
                if (el.children.length === 0) {
                    const t = el.textContent.trim();
                    if (/^\d{4}-\d{2}-\d{2}$/.test(t)) {
                        const [y, m, d] = t.split('-');
                        el.textContent = `${d}-${m}-${y}`;
                        el.classList.add('fecha-espanol');
                    }
                }
            });

            document.querySelectorAll('div, span, h1, h2, h3, h4, h5, h6, a, p').forEach(el => {
                if (el.children.length === 0 && el.textContent.trim().length > 0) {
                    const rect = el.getBoundingClientRect();
                    if (rect.top >= 0 && rect.bottom <= 65) {
                        if (rect.width > 0 && rect.height > 0) {
                            el.style.setProperty('color', '#ffffff', 'important');
                        }
                    }
                }
            });

        }, 500);

        // ==========================================
        // 3. SISTEMA DE MAPAS (LEAFLET + REPARACI√ìN)
        // ==========================================
        (function () {
            console.log("Inicializando sistema de mapas (Modo Reparaci√≥n)...");

            const NOMINATIM_BASE_URL = "https://nominatim.openstreetmap.org/search";
            let mapInstance = null;
            let markerCluster = null;
            let lastDataSignature = "";

            // --- A. GEOCODIFICADOR AUTOM√ÅTICO (Con Reporte Visual) ---
            async function autoGeocode() {
                const clientsStr = localStorage.getItem('clients');
                if (!clientsStr) return;
                let clients = [];
                try { clients = JSON.parse(clientsStr); } catch (e) { return; }

                // Filtrar pendientes que tengan direcci√≥n v√°lida
                const allPending = clients.filter(c =>
                    (c.address || c.direccion) &&
                    (!c.lat || !c.lon || c.lat === 0 || c.lon === 0)
                );

                // Actualizar contador visual si existe
                const statusEl = document.getElementById('geo-status-text');
                if (statusEl) {
                    if (allPending.length > 0) {
                        statusEl.innerHTML = `Buscando direcciones...<br>Pendientes: <b>${allPending.length}</b>`;
                        statusEl.style.color = '#eab308'; // Amarillo
                    } else {
                        statusEl.innerHTML = `¬°Todo localizado!<br>Clientes en mapa.`;
                        statusEl.style.color = '#22c55e'; // Verde
                    }
                }

                // Tomar el primero para procesar
                const pending = allPending[0];

                if (pending) {
                    const address = pending.address || pending.direccion || "";
                    const city = pending.city || pending.poblacion || "";
                    const province = pending.province || pending.provincia || "";
                    
                    if (!address || address.length < 3) return; 

                    const query = `${address}, ${city}, ${province}, Espa√±a`;

                    try {
                        const res = await fetch(`${NOMINATIM_BASE_URL}?q=${encodeURIComponent(query)}&format=json&limit=1`);
                        if (res.ok) {
                            const data = await res.json();
                            if (data && data.length > 0) {
                                pending.lat = parseFloat(data[0].lat);
                                pending.lon = parseFloat(data[0].lon);
                                
                                // Guardar
                                const index = clients.findIndex(c => c.id === pending.id);
                                if (index !== -1) {
                                    clients[index] = pending;
                                    localStorage.setItem('clients', JSON.stringify(clients));
                                    // Recargar marcadores para ver aparecer la chincheta
                                    reloadMarkers(true);
                                }
                            } else {
                                // No encontrado - Marcar como "no encontrado" para no buclear infinitamente?
                                // De momento lo dejamos para que reintente en el futuro o si se corrige la direcci√≥n
                            }
                        }
                    } catch (err) { }
                }
            }
            // Ejecutar cada 2 segundos
            setInterval(autoGeocode, 2000);

            // --- B. VISTA DE MAPA Y CONTROLES ---
            function checkMapView() {
                const myMap = document.getElementById('custom-leaflet-map');
                
                const isMapActive = Array.from(document.querySelectorAll('span, div, p')).some(el =>
                    el.textContent.trim() === 'Mapa' &&
                    (el.classList.contains('active') || el.closest('.active') || el.style.color === 'white' || location.href.includes('map'))
                );

                if (isMapActive) {
                    if (!myMap) {
                        // Crear contenedor
                        const overlay = document.createElement('div');
                        overlay.id = 'custom-leaflet-map';
                        overlay.style.position = 'fixed';
                        overlay.style.top = '60px';
                        overlay.style.left = '0';
                        overlay.style.width = '100%';
                        overlay.style.height = 'calc(100% - 120px)';
                        overlay.style.zIndex = '99999';
                        overlay.style.backgroundColor = 'white';
                        document.body.appendChild(overlay);

                        // --- PANEL DE CONTROL (NUEVO) ---
                        const controls = document.createElement('div');
                        controls.style.position = 'absolute';
                        controls.style.top = '10px';
                        controls.style.right = '10px';
                        controls.style.zIndex = '10000';
                        controls.style.backgroundColor = 'rgba(255, 255, 255, 0.95)';
                        controls.style.padding = '10px';
                        controls.style.borderRadius = '8px';
                        controls.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
                        controls.style.maxWidth = '200px';
                        controls.style.fontSize = '12px';
                        controls.style.textAlign = 'center';
                        
                        controls.innerHTML = `
                            <div id="geo-status-text" style="margin-bottom:8px; font-weight:600; color:#444;">Estado: Listo</div>
                            <button id="btn-reset-geo" style="background:#ef4444; color:white; border:none; padding:6px 12px; border-radius:4px; font-weight:bold; cursor:pointer; width:100%;">
                                üóëÔ∏è Resetear Ubicaciones
                            </button>
                            <div style="font-size:10px; color:#888; margin-top:5px;">Pulsa si las ubicaciones son incorrectas.</div>
                        `;
                        overlay.appendChild(controls);

                        // L√≥gica del bot√≥n Reset
                        document.getElementById('btn-reset-geo').onclick = function() {
                            if(confirm("¬øEst√°s seguro?\n\nEsto borrar√° TODAS las posiciones actuales del mapa y obligar√° al sistema a buscarlas de nuevo por direcci√≥n.\n\nPuede tardar varios minutos en volver a colocar a todos los clientes.")) {
                                try {
                                    const c = JSON.parse(localStorage.getItem('clients')||'[]');
                                    let count = 0;
                                    c.forEach(x => {
                                        if (x.lat && x.lon) {
                                            x.lat = 0;
                                            x.lon = 0;
                                            count++;
                                        }
                                    });
                                    localStorage.setItem('clients', JSON.stringify(c));
                                    alert(`Se han reseteado ${count} clientes. El mapa se recargar√° y empezar√° la b√∫squeda autom√°tica.`);
                                    location.reload();
                                } catch(e) { alert("Error al resetear: " + e); }
                            }
                        };


                        // Inicializar Leaflet
                        mapInstance = L.map('custom-leaflet-map').setView([40.4168, -3.7038], 6);

                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; OpenStreetMap contributors'
                        }).addTo(mapInstance);

                        markerCluster = L.markerClusterGroup({
                            maxClusterRadius: 40,
                            spiderfyOnMaxZoom: true,
                            showCoverageOnHover: false,
                            zoomToBoundsOnClick: true
                        });
                        mapInstance.addLayer(markerCluster);

                        reloadMarkers(true);
                    } else {
                        myMap.style.display = 'block';
                        reloadMarkers(false);
                    }
                } else {
                    if (myMap) {
                        myMap.style.display = 'none';
                    }
                }
            }

            function reloadMarkers(force = false) {
                if (!mapInstance) return;

                const clientsStr = localStorage.getItem('clients');
                const ordersStr = localStorage.getItem('orders');
                if (!clientsStr) return;

                const currentDataSig = clientsStr.length + "-" + (ordersStr ? ordersStr.length : 0);
                if (!force && currentDataSig === lastDataSignature) return;
                lastDataSignature = currentDataSig;

                if (window.markerCluster) {
                    markerCluster.clearLayers();
                }

                try {
                    const clients = JSON.parse(clientsStr);
                    const orders = ordersStr ? JSON.parse(ordersStr) : [];
                    const now = new Date();
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(now.getDate() - 30);

                    const createIcon = (colorUrl) => {
                        return new L.Icon({
                            iconUrl: colorUrl,
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        });
                    };

                    const greenIcon = createIcon('https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png');
                    const redIcon = createIcon('https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png');

                    const markersToAdd = [];

                    clients.forEach(c => {
                        // Solo pintar si tiene coords v√°lidas y NO son 0,0
                        if (c.lat && c.lon && (c.lat !== 0 || c.lon !== 0)) {
                            let lastOrderDate = null;
                            const clientOrders = orders.filter(o =>
                                o.cliente_id == c.id || o.client_code == c.code || (o.cliente && o.cliente.includes(c.name))
                            );

                            if (clientOrders.length > 0) {
                                clientOrders.sort((a, b) => new Date(b.timestamp || b.fecha) - new Date(a.timestamp || a.fecha));
                                const lastOrder = clientOrders[0];
                                if (lastOrder.timestamp || lastOrder.fecha) {
                                    lastOrderDate = new Date(lastOrder.timestamp || lastOrder.fecha);
                                }
                            }

                            let iconToUse = redIcon;
                            if (lastOrderDate && lastOrderDate >= thirtyDaysAgo) {
                                iconToUse = greenIcon;
                            }

                            const marker = L.marker([c.lat, c.lon], { icon: iconToUse });
                            const name = c.name || c.nombre || "Cliente";
                            const address = c.address || c.direccion || "";
                            const lastDateStr = lastOrderDate ? lastOrderDate.toLocaleDateString() : "Sin pedidos recientes";

                            marker.bindPopup(`
                                <div style="text-align:center; min-width: 150px;">
                                    <b style="font-size:14px;">${name}</b><br>
                                    <span style="font-size:11px; color:#555;">${address}</span><br>
                                    <div style="margin-top:6px; padding:4px 8px; background:${lastOrderDate ? '#22c55e' : '#ef4444'}; color:white; border-radius:4px; font-size:11px; display:inline-block; font-weight:bold;">
                                        ${lastOrderDate ? '√öltimo: ' + lastDateStr : 'Sin pedidos recientes'}
                                    </div>
                                </div>
                            `);
                            markersToAdd.push(marker);
                        }
                    });

                    if (markersToAdd.length > 0) {
                        markerCluster.addLayers(markersToAdd);
                    }

                } catch (e) { console.error("Error pintando mapa:", e); }
            }

            setInterval(checkMapView, 500);

        })();
    </script>
</body>

</html>
