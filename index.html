<!doctype html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./logo_myl.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-title" content="Ventas M&L" />
    <title>Gestión de Ventas</title>

    <script type="module" crossorigin src="./index-NVVWiGcP.js"></script>
    <link rel="stylesheet" href="./index-cqvvk0bb.css?v=final">
    <link rel="manifest" href="./manifest.webmanifest">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <style>
        /* Asegurar que la página ocupa el 100% para que el mapa no tenga altura 0 */
        html, body { height: 100%; margin: 0; padding: 0; overflow-x: hidden; }
        
        /* Contenedor del Mapa (Oculto por defecto) */
        #capa-mapa-seguro {
            display: none; /* Se activa con JS */
            position: fixed;
            top: 0; 
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 99999; /* Por encima de todo */
        }

        #mapa-real {
            width: 100%;
            height: 100%;
        }

        /* Panel de Controles Flotante */
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10000;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            width: 200px;
            text-align: center;
            font-family: sans-serif;
        }

        /* Botón Cerrar (Grande para dedos) */
        .btn-close {
            position: absolute;
            top: -10px;
            left: -10px;
            width: 36px;
            height: 36px;
            background: white;
            border: 2px solid #ccc;
            border-radius: 50%;
            font-weight: bold;
            font-size: 18px;
            line-height: 32px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            color: #333;
        }

        /* Estilos Quirúrgicos de la App */
        .euro-menu-fix { font-size: 24px !important; display: inline-block; line-height: 1; transform: translateY(1px); }
        .texto-ventas { text-transform: uppercase !important; font-weight: 700 !important; color: #ffffff !important; }
        .fecha-espanol { font-size: 11px !important; font-weight: 700 !important; color: #94a3b8 !important; margin-bottom: 2px !important; display: block !important; }
    </style>
</head>

<body>
    <div id="root"></div>

    <div id="capa-mapa-seguro">
        <div class="map-controls">
            <button class="btn-close" onclick="cerrarMapa()">✕</button>
            <div id="status-text" style="font-size:12px; font-weight:bold; margin-bottom:8px; color:#444;">
                Cargando mapa...
            </div>
            <button onclick="resetearDatos()" style="background:#ef4444; color:white; border:none; padding:8px; width:100%; border-radius:4px; font-weight:bold; cursor:pointer;">
                ⚠️ Resetear Fallos
            </button>
        </div>
        <div id="mapa-real"></div>
    </div>

    <script>
        // --- 1. DETECTOR DE ERRORES GLOBAL (CHIVATO) ---
        window.onerror = function(msg, url, line) {
            // Si hay un error crítico, avisar al usuario
            if (msg.toLowerCase().includes('leaflet') || msg.toLowerCase().includes('map') || msg.toLowerCase().includes('json')) {
                alert("ERROR DETECTADO: " + msg + "\n\nPulsa 'Resetear Fallos' si esto persiste.");
            }
        };

        // Funciones Globales para los botones HTML
        window.cerrarMapa = function() {
            document.getElementById('capa-mapa-seguro').style.display = 'none';
        };

        window.resetearDatos = function() {
            if(confirm("¿Seguro? Esto borrará la caché de ubicaciones de la app para intentar arreglar el error.")) {
                try {
                    // Borramos solo lat/lon corruptos
                    const clients = JSON.parse(localStorage.getItem('clients') || '[]');
                    clients.forEach(c => { c.lat = 0; c.lon = 0; });
                    localStorage.setItem('clients', JSON.stringify(clients));
                    alert("Datos limpiados. La página se recargará.");
                    location.reload();
                } catch(e) {
                    alert("Error al limpiar: " + e);
                    localStorage.clear(); // Opción nuclear si falla todo
                    location.reload();
                }
            }
        };

        // --- 2. LÓGICA DEL MAPA ---
        let mapInstance = null;
        let isMapVisible = false;

        function iniciarMapa() {
            if (mapInstance) return; // Ya existe

            try {
                if (typeof L === 'undefined') {
                    throw new Error("La librería Leaflet no ha cargado. Revisa tu conexión.");
                }

                // Crear mapa en el div 'mapa-real'
                mapInstance = L.map('mapa-real').setView([40.4168, -3.7038], 6);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(mapInstance);

                console.log("Mapa iniciado correctamente");
                cargarPuntos();

            } catch (error) {
                console.error(error);
                document.getElementById('status-text').innerText = "Error: " + error.message;
                document.getElementById('status-text').style.color = "red";
            }
        }

        function cargarPuntos() {
            if (!mapInstance) return;

            // Limpiar pines anteriores
            mapInstance.eachLayer(layer => {
                if (layer instanceof L.Marker) mapInstance.removeLayer(layer);
            });

            try {
                const clientsStr = localStorage.getItem('clients');
                const ordersStr = localStorage.getItem('orders');
                
                if (!clientsStr) {
                    document.getElementById('status-text').innerText = "No hay clientes cargados.";
                    return;
                }

                const clients = JSON.parse(clientsStr);
                const orders = ordersStr ? JSON.parse(ordersStr) : [];
                const now = new Date();
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(now.getDate() - 30);

                let contados = 0;
                let pendientes = 0;

                // Iconos
                const LeafIcon = L.Icon.extend({
                    options: { iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', shadowSize: [41, 41] }
                });
                const greenIcon = new LeafIcon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png' });
                const redIcon = new LeafIcon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png' });

                clients.forEach(c => {
                    // Validar Coordenadas
                    if (c.lat && c.lon && !isNaN(c.lat) && c.lat !== 0) {
                        contados++;
                        
                        // Lógica Último Pedido
                        let lastOrderDate = null;
                        const misPedidos = orders.filter(o => o.cliente_id == c.id || (o.cliente && o.cliente.includes(c.name)));
                        if (misPedidos.length > 0) {
                            misPedidos.sort((a,b) => new Date(b.fecha||b.timestamp) - new Date(a.fecha||a.timestamp));
                            lastOrderDate = new Date(misPedidos[0].fecha||misPedidos[0].timestamp);
                        }

                        const colorIcon = (lastOrderDate && lastOrderDate >= thirtyDaysAgo) ? greenIcon : redIcon;
                        
                        L.marker([c.lat, c.lon], { icon: colorIcon })
                            .bindPopup(`<b>${c.name}</b><br>${c.address || ''}`)
                            .addTo(mapInstance);
                    } else if (c.address) {
                        pendientes++;
                    }
                });

                document.getElementById('status-text').innerText = `Mapa: ${contados} clientes.\nFaltan ubicar: ${pendientes}`;
                
                // Si hay muchos pendientes, iniciar geocodificación lenta en background
                if (pendientes > 0) setTimeout(autoGeocodeOne, 1000);

            } catch (e) {
                console.error(e);
                alert("Error leyendo datos: " + e.message);
            }
        }

        // --- 3. GEOCODIFICADOR LENTO (1 CADA 3 SEG) ---
        async function autoGeocodeOne() {
            if (!isMapVisible) return; // Solo buscar si el mapa está abierto
            
            try {
                const clients = JSON.parse(localStorage.getItem('clients') || '[]');
                const target = clients.find(c => (c.address && c.address.length > 3) && (!c.lat || c.lat === 0));

                if (target) {
                    const query = `${target.address}, ${target.city||''}, ${target.province||''}, España`;
                    document.getElementById('status-text').innerHTML = `Buscando:<br><span style="color:blue">${target.name.substring(0,15)}...</span>`;
                    
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`);
                    if (res.ok) {
                        const data = await res.json();
                        if (data.length > 0) {
                            target.lat = parseFloat(data[0].lat);
                            target.lon = parseFloat(data[0].lon);
                            
                            // Guardar y repintar
                            const idx = clients.findIndex(x => x.id === target.id);
                            if (idx !== -1) {
                                clients[idx] = target;
                                localStorage.setItem('clients', JSON.stringify(clients));
                                cargarPuntos(); // Recargar mapa
                            }
                        } else {
                            // Marcar como no encontrado temporalmente para no atascarse
                            // (Opcional: podriamos poner lat=0.0001 para saltarlo)
                        }
                    }
                } else {
                    document.getElementById('status-text').innerText = "Todos los clientes ubicados.";
                    document.getElementById('status-text').style.color = "green";
                }
            } catch(e) {}
            
            // Repetir
            if (isMapVisible) setTimeout(autoGeocodeOne, 3000);
        }

        // --- 4. BUCLE PRINCIPAL (Monitoriza la UI) ---
        setInterval(() => {
            // A. Detectar si el usuario quiere ver el mapa
            const botonMapaActivo = Array.from(document.querySelectorAll('span, div, p, a')).some(el =>
                el.textContent.trim() === 'Mapa' &&
                (el.classList.contains('active') || el.closest('.active') || window.location.href.includes('map'))
            );

            const capaMapa = document.getElementById('capa-mapa-seguro');

            if (botonMapaActivo) {
                if (!isMapVisible) {
                    // ABRIR MAPA
                    isMapVisible = true;
                    capaMapa.style.display = 'block';
                    
                    // Asegurar renderizado Leaflet
                    setTimeout(() => {
                        iniciarMapa();
                        if (mapInstance) mapInstance.invalidateSize(); 
                    }, 100);
                }
            } else {
                // Si el usuario sale de la sección mapa, ocultamos la capa
                // PERO permitimos que la capa se mantenga si la abrimos nosotros (override)
                // Para simplificar: si la URL o el menú no dice mapa, ocultamos.
                // EXCEPCION: Si la capa está visible y el usuario NO ha navegado fuera (la app es SPA)
                // A veces es mejor dejar el botón de cerrar manual 'X' para controlar esto.
            }

            // B. ARREGLOS VISUALES (Mantenidos del original)
            const dashSpans = Array.from(document.querySelectorAll('span, p, div')).filter(e => e.textContent.trim() === 'Dash');
            let barraMenu = null;
            for (const span of dashSpans) {
                if (span.getBoundingClientRect().top > window.innerHeight - 100) {
                    let cand = span.parentElement;
                    if (cand && cand.parentElement && cand.parentElement.children.length > 4) {
                        barraMenu = cand.parentElement; break;
                    }
                }
            }
            if (barraMenu) {
                Array.from(barraMenu.children).forEach(boton => {
                    boton.style.background = 'transparent'; boton.style.boxShadow = 'none'; boton.style.border = 'none';
                    boton.querySelectorAll('*').forEach(h => { if(h.tagName!='SVG'&&h.tagName!='IMG') h.style.color='white'; });
                    boton.querySelectorAll('svg, img').forEach(i => i.style.filter='brightness(0) invert(1)');
                });
            }

            // Textos Blancos en Header
            document.querySelectorAll('div, span, h1, h2').forEach(el => {
                if(el.children.length===0 && el.textContent.trim().length>0 && el.getBoundingClientRect().bottom < 65) {
                    el.style.setProperty('color', '#ffffff', 'important');
                }
            });

        }, 500);

    </script>
</body>
</html>
