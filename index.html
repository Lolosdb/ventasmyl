<!doctype html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./logo_myl.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Gesti√≥n de Ventas</title>

    <script>
        const fakePos = { coords: { latitude: 40.4168, longitude: -3.7038, accuracy: 50 }, timestamp: Date.now() };
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition = (s) => s(fakePos);
            navigator.geolocation.watchPosition = (s) => { s(fakePos); return 999; };
        }
    </script>

    <script type="module" crossorigin src="./index-NVVWiGcP.js"></script>
    <link rel="stylesheet" href="./index-cqvvk0bb.css?v=final">
    <link rel="manifest" href="./manifest.webmanifest">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* ESTILOS GENERALES */
        body { margin: 0; background-color: #1e293b; font-family: sans-serif; }
        .leaflet-container:not(#mi-mapa-real) { opacity: 0 !important; pointer-events: none !important; z-index: 0 !important; }
        
        /* Arreglos Visuales App Original */
        .euro-menu-fix { font-size: 24px !important; display: inline-block; transform: translateY(1px); }
        .texto-ventas { text-transform: uppercase !important; font-weight: 700 !important; color: #ffffff !important; }

        /* --- BOT√ìN FLOTANTE --- */
        #btn-lanzar-mapa {
            position: fixed; bottom: 90px; right: 20px;
            background: #2563eb; color: white;
            padding: 12px 20px; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            font-weight: bold; font-family: sans-serif;
            z-index: 9999; cursor: pointer;
            border: 2px solid rgba(255,255,255,0.3);
            display: flex; align-items: center; gap: 8px;
        }

        /* --- VISOR MAPA --- */
        #visor-mapa {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: white; z-index: 100000;
        }
        #mi-mapa-real { width: 100%; height: 100%; }

        /* --- PANEL CONTROL --- */
        #panel-control {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.98); padding: 15px;
            border-radius: 16px; box-shadow: 0 5px 20px rgba(0,0,0,0.25);
            z-index: 100001; width: 90%; max-width: 400px;
        }

        .fila-stats { display: flex; justify-content: space-between; font-size: 13px; color: #333; margin-top: 8px; }
        .barra-bg { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .barra-fill { height: 100%; background: #2563eb; width: 0%; transition: width 0.3s; }
        
        /* Botones */
        .btn-grande {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-bottom: 5px; font-size: 14px;
        }
        .btn-azul { background: #2563eb; color: white; }
        .btn-rojo { background: transparent; color: #ef4444; border: 1px solid #ef4444; margin-top: 10px; font-size: 12px; padding: 8px; }
        
        .btn-cerrar {
            position: absolute; top: 10px; right: 10px; width: 30px; height: 30px;
            background: white; border: 1px solid #ccc; border-radius: 50%; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center;
        }
        
        #input-excel { display: none; }
    </style>
</head>

<body>
    <div id="root"></div>

    <div id="btn-lanzar-mapa" onclick="abrirMapa()">
        üåç MAPA & IMPORTAR
    </div>

    <div id="visor-mapa">
        <button class="btn-cerrar" onclick="cerrarMapa()">‚úï</button>
        
        <div id="panel-control">
            <h3 style="margin:0 0 10px 0; font-size:16px; color:#111;">Importador Directo (Col E, G, H)</h3>
            
            <input type="file" id="input-excel" accept=".xlsx, .xls, .csv" onchange="leerExcelPorColumnas(this)" />
            
            <button class="btn-grande btn-azul" onclick="document.getElementById('input-excel').click()">
                üìÇ Cargar Excel Clientes
            </button>
            <div style="font-size:11px; color:#666; text-align:center; margin-bottom:10px;">
                Usar√° columnas fijas: Tienda (B), Direcci√≥n (E), Pob (G), Prov (H)
            </div>

            <div id="area-progreso" style="display:none; background:#f9fafb; padding:10px; border-radius:8px;">
                <div class="fila-stats">
                    <span id="txt-estado" style="font-weight:bold; color:#2563eb;">Preparado</span>
                    <span id="txt-contador">0/0</span>
                </div>
                <div class="barra-bg"><div id="barra-progreso" class="barra-fill"></div></div>
                <div id="txt-debug" style="font-size:10px; color:#999; margin-top:5px; white-space:nowrap; overflow:hidden;"></div>
            </div>

            <button class="btn-grande btn-rojo" onclick="borrarDatos()">
                üóëÔ∏è Borrar todo
            </button>
        </div>
        <div id="mi-mapa-real"></div>
    </div>

    <script>
        // --- 1. MANTENIMIENTO VISUAL ---
        setInterval(() => {
            document.querySelectorAll('div, p, span').forEach(el => {
                if(el.textContent && el.textContent.includes('Mejorando precisi√≥n')) el.style.display = 'none';
            });
            const menus = document.querySelectorAll('div');
            menus.forEach(d => {
                if(d.style.position === 'fixed' && d.style.bottom === '0px') {
                     d.querySelectorAll('svg, img').forEach(i => i.style.filter='brightness(0) invert(1)');
                }
            });
            document.querySelectorAll('h1, h2, h3, div, span').forEach(el => {
                if(el.textContent.trim().length > 0 && el.getBoundingClientRect().top < 65 && !el.closest('#visor-mapa')) {
                     const s = window.getComputedStyle(el);
                     if(s.color !== 'rgb(255, 255, 255)') el.style.setProperty('color', '#ffffff', 'important');
                }
            });
        }, 1000);

        // --- 2. MAPA ---
        let map = null;
        function abrirMapa() {
            document.getElementById('visor-mapa').style.display = 'block';
            setTimeout(() => {
                if (!map) {
                    map = L.map('mi-mapa-real').setView([40.4168, -3.7038], 6);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
                }
                map.invalidateSize();
                pintarMapa();
            }, 200);
        }
        function cerrarMapa() { document.getElementById('visor-mapa').style.display = 'none'; }
        
        function borrarDatos() {
            if(confirm("¬øBorrar todos los clientes?")) {
                localStorage.setItem('clients', '[]');
                location.reload();
            }
        }

        // --- 3. LECTOR EXCEL "TIRO FIJO" (Por √≠ndices de columna) ---
        async function leerExcelPorColumnas(input) {
            const file = input.files[0];
            if (!file) return;

            document.getElementById('area-progreso').style.display = 'block';
            document.getElementById('txt-estado').innerText = "Leyendo columnas...";
            
            const reader = new FileReader();
            reader.readAsArrayBuffer(file);
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // header:1 nos da un Array de Arrays (Matriz), ideal para acceder por posici√≥n
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    
                    if (!rows || rows.length === 0) { alert("Archivo vac√≠o"); return; }

                    // √çndices seg√∫n tu archivo (Empezando en 0):
                    // B -> 1 (Nombre Tienda)
                    // E -> 4 (Direcci√≥n)
                    // G -> 6 (Poblaci√≥n)
                    // H -> 7 (Provincia)
                    // A -> 0 (C√≥digo/ID)

                    let clientesExtraidos = [];
                    // Empezamos en 1 para saltar la cabecera
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        if (!row || row.length < 5) continue; // Ignorar filas vac√≠as

                        // Limpiar datos
                        const clean = (val) => val ? val.toString().trim().replace(/['"]/g, '') : "";

                        const nombre = clean(row[1]); // Columna B
                        const direccion = clean(row[4]); // Columna E
                        const poblacion = clean(row[6]); // Columna G
                        const provincia = clean(row[7]); // Columna H
                        const id = clean(row[0]) || ('GEN-' + i); // Columna A

                        if (nombre && direccion) {
                            clientesExtraidos.push({
                                id: id,
                                name: nombre,
                                address: direccion,
                                city: poblacion,
                                province: provincia,
                                lat: 0, lon: 0 // Pendiente de buscar
                            });
                        }
                    }

                    if (clientesExtraidos.length === 0) {
                        alert("No he podido extraer datos. Revisa que las columnas sean B, E, G, H.");
                        return;
                    }

                    // GUARDAR Y ARRANCAR
                    localStorage.setItem('clients', JSON.stringify(clientesExtraidos));
                    alert(`‚úÖ Le√≠dos ${clientesExtraidos.length} clientes.\nIniciando b√∫squeda GPS (1 seg/cliente)...`);
                    
                    pintarMapa();
                    procesarColaGPS(); // Iniciar motor robusto

                } catch (err) {
                    alert("Error leyendo Excel: " + err.message);
                }
            };
        }

        // --- 4. MOTOR GPS (NO REPETITIVO) ---
        async function procesarColaGPS() {
            // Recargar siempre del disco para tener la versi√≥n m√°s fresca
            const clients = JSON.parse(localStorage.getItem('clients') || '[]');
            
            // Buscar pendientes: aquellos que no tienen latitud O tienen latitud 0
            // ¬°OJO! Los que tienen lat=0.0001 YA EST√ÅN PROCESADOS (como no encontrados), as√≠ que los ignoramos
            const pendientes = clients.filter(c => (!c.lat || c.lat === 0));
            
            const total = clients.length;
            const hechos = total - pendientes.length;
            
            // Actualizar UI
            const porc = Math.round((hechos / total) * 100);
            document.getElementById('barra-progreso').style.width = porc + "%";
            document.getElementById('txt-contador').innerText = `${hecos}/${total}`;
            
            if (pendientes.length === 0) {
                document.getElementById('txt-estado').innerText = "‚úÖ Todo Completado";
                document.getElementById('txt-debug').innerText = "";
                return; // Fin del trabajo
            }

            const target = pendientes[0]; // Tomamos el primero de la cola

            // UI Feedback
            document.getElementById('txt-estado').innerText = "Buscando coordenadas...";
            document.getElementById('txt-debug').innerText = `>> ${target.name}`;

            let latEncontrada = 0.0001; // Valor por defecto (No encontrado)
            let lonEncontrada = 0.0001;

            try {
                // INTENTO 1: Direcci√≥n completa
                // Limpiamos la direcci√≥n de cosas raras antes de la coma si es muy larga
                let direccionSimple = target.address.split(',')[0]; 
                const query = `${direccionSimple}, ${target.city}, ${target.province}, Espa√±a`;
                
                let data = await fetchNominatim(query);

                if (data) {
                    latEncontrada = data.lat;
                    lonEncontrada = data.lon;
                } else {
                    // INTENTO 2: Solo Ciudad (Fallback)
                    console.log("Direcci√≥n exacta fall√≥, probando solo ciudad...");
                    data = await fetchNominatim(`${target.city}, ${target.province}, Espa√±a`);
                    if (data) {
                        latEncontrada = data.lat;
                        lonEncontrada = data.lon;
                    }
                }

            } catch (err) {
                console.log("Error de red, saltando...");
            }

            // --- GUARDADO CR√çTICO ---
            // Buscamos el √≠ndice original para actualizarlo
            const idxReal = clients.findIndex(c => c.id === target.id);
            if (idxReal !== -1) {
                clients[idxReal].lat = latEncontrada;
                clients[idxReal].lon = lonEncontrada;
                
                // Guardamos en memoria inmediatamente
                localStorage.setItem('clients', JSON.stringify(clients));
            }

            // Pintamos el mapa con el nuevo punto (si se encontr√≥)
            if (latEncontrada > 1) pintarMapa();

            // PASAMOS AL SIGUIENTE
            // Esperamos 1.2 segundos para respetar l√≠mites de la API y evitar bloqueos
            setTimeout(procesarColaGPS, 1200);
        }

        async function fetchNominatim(q) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&limit=1`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.length > 0) return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                }
            } catch(e) { }
            return null;
        }

        function pintarMapa() {
            if(!map) return;
            map.eachLayer(l => { if(l instanceof L.Marker) map.removeLayer(l); });

            const clients = JSON.parse(localStorage.getItem('clients') || '[]');
            const greenIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', shadowSize:[41,41] });
            const redIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', shadowSize:[41,41] });

            clients.forEach(c => {
                // Solo pintamos si tiene lat > 1 (ignoramos los 0 y los 0.0001)
                if (c.lat && c.lon && c.lat > 1) {
                    L.marker([c.lat, c.lon], { icon: redIcon })
                        .bindPopup(`<div style="text-align:center"><b>${c.name}</b><br>${c.address}<br>${c.city}</div>`)
                        .addTo(map);
                }
            });
        }
    </script>
</body>
</html>
